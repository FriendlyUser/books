<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- favicon -->
    <link rel="shortcut icon" href="/images/favicon.png">
    <!-- theme meta -->
    <meta name="theme-name" content="pinwheel-astro">
    <meta name="msapplication-TileColor" content="#000000">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2479144310234386" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-119155027-6">

  </script>
  
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#fff">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
    <meta name="generator" content="Astro v2.6.6">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <!-- google font css -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&#38;family=Merriweather:wght@700;900&#38;display=swap" rel="stylesheet">

    <link href="/_pagefind/pagefind-ui.css" rel="stylesheet">
		<script src="/_pagefind/pagefind-ui.js" type="text/javascript"></script>

    <!-- responsive meta -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">

    <!-- title -->
    <title>
      Introduction to Rust and Command Line Applications
    </title>

    <!-- canonical url -->
    

    <!-- noindex robots -->
    

    <!-- meta-description -->
    <meta name="description" content="Implementing core linux command line applications in Rust">

    <!-- author from config.json -->
    <meta name="author" content="FriendlyUser">

    <!-- og-title -->
    <meta property="og:title" content="Introduction to Rust and Command Line Applications">

    <!-- og-description -->
    <meta property="og:description" content="Implementing core linux command line applications in Rust">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pinwheel-astro.vercel.app/books/rust_cli_main/">

    <!-- twitter-title -->
    <meta name="twitter:title" content="Introduction to Rust and Command Line Applications">

    <!-- twitter-description -->
    <meta name="twitter:description" content="Implementing core linux command line applications in Rust">

    <!-- og-image -->
    <meta property="og:image" content="https://pinwheel-astro.vercel.app/images/og-image.png">

    <!-- twitter-image -->
    <meta name="twitter:image" content="https://pinwheel-astro.vercel.app/images/og-image.png">
    <meta name="twitter:card" content="summary_large_image">
  <link rel="stylesheet" href="/_astro/_single_.db0af2d4.css" />
<link rel="stylesheet" href="/_astro/404.99013387.css" /><script type="module" src="/_astro/hoisted.f0b9be19.js"></script></head>
  <body>
    
    <header class="header">
  <nav class="navbar container">
    <!-- logo -->
    <div class="order-0">
      <a href="/" class="navbar-brand block">
  <img alt="Pinwheel Astro" style="height:31px;width:147px" width="294" height="62" src="/_astro/logo_ZThIBR.png" loading="lazy" decoding="async">
</a>
    </div>
    <!-- navbar toggler -->
    <input id="nav-toggle" type="checkbox" class="hidden">
    <label id="show-button" for="nav-toggle" class="order-2 flex cursor-pointer items-center lg:order-1 lg:hidden">
      <svg class="h-6 fill-current" viewBox="0 0 20 20">
        <title>Menu Open</title>
        <path d="M0 3h20v2H0V3z m0 6h20v2H0V9z m0 6h20v2H0V0z"></path>
      </svg>
    </label>
    <label id="hide-button" for="nav-toggle" class="order-2 hidden cursor-pointer items-center lg:order-1">
      <svg class="h-6 fill-current" viewBox="0 0 20 20">
        <title>Menu Close</title>
        <polygon points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2" transform="rotate(45 10 10)"></polygon>
      </svg>
    </label>
    <!-- /navbar toggler -->

    <ul id="nav-menu" class="navbar-nav order-3 hidden w-full lg:order-1 lg:flex lg:w-auto lg:space-x-2">
      <li class="nav-item">
                <a href="/" class="nav-link inline-block lg:block false">
                  Home
                </a>
              </li><li class="nav-item">
                <a href="/books" class="nav-link inline-block lg:block false">
                  Books
                </a>
              </li><li class="nav-item">
                <a href="/contact" class="nav-link inline-block lg:block false">
                  Contact
                </a>
              </li>
      <li class="nav-item mt-2 lg:hidden">
        <a class="btn btn-white btn-sm border-border" href="/books">
          View Books</a>
      </li>
    </ul>
    <div class="order-1 ml-auto hidden items-center md:order-2 md:ml-0 lg:flex">
      <a class="btn btn-white btn-sm" href="/signin"> View Books</a>
    </div>
  </nav>
</header>
<script>
  const button = document.getElementById("dropdown-button");
  button.addEventListener("click", () => {
    const dropdown = document.getElementById("dropdown");
    dropdown.classList.toggle(dropdown.style === "hidden" ? "block" : "hidden");
  });

  //sticky header
  const header = document.querySelector(".header");
  window.addEventListener("scroll", () => {
    const scrollY = window.scrollY;
    if (scrollY > 0) {
      header.classList.add("header-sticky");
    } else {
      header.classList.remove("header-sticky");
    }
  });
</script>
    <main id="main-content">
      
  <section class="section blog-single">
    <div class="container">
      <div class="row justify-center">
        <div class="lg:col-10">
          <img class="w-full rounded-xl" alt="" width="920" height="450" src="/_astro/2861854918_1ejygV.png" loading="lazy" decoding="async">
        </div>
        <div class="mt-10 max-w-[810px] lg:col-9">
          <h1 class="h2">
            Introduction to Rust and Command Line Applications
          </h1>
          <div class="mb-5 mt-6 flex items-center space-x-2">
            <ul class="mb-4">
              <li class="mr-4 inline-block">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 496 512" class="mr-2 -mt-1 inline-block" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M248 104c-53 0-96 43-96 96s43 96 96 96 96-43 96-96-43-96-96-96zm0 144c-26.5 0-48-21.5-48-48s21.5-48 48-48 48 21.5 48 48-21.5 48-48 48zm0-240C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 448c-49.7 0-95.1-18.3-130.1-48.4 14.9-23 40.4-38.6 69.6-39.5 20.8 6.4 40.6 9.6 60.5 9.6s39.7-3.1 60.5-9.6c29.2 1 54.7 16.5 69.6 39.5-35 30.1-80.4 48.4-130.1 48.4zm162.7-84.1c-24.4-31.4-62.1-51.9-105.1-51.9-10.2 0-26 9.6-57.6 9.6-31.5 0-47.4-9.6-57.6-9.6-42.9 0-80.6 20.5-105.1 51.9C61.9 339.2 48 299.2 48 256c0-110.3 89.7-200 200-200s200 89.7 200 200c0 43.2-13.9 83.2-37.3 115.9z"></path></svg>
                
              </li>

              <!-- <li class="mr-4 inline-block">
                <FaRegCalendarAlt className={"mr-2 -mt-1 inline-block"} />
                {dateFormat(post.data?.pubDate)}
              </li> -->
              <li class="mr-4 inline-block">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="mr-2 -mt-1 inline-block" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5 0-200-89.5-200-200S145.5 56 256 56s200 89.5 200 200-89.5 200-200 200zm61.8-104.4l-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6 0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"></path></svg>
                62 Mins read
              </li>
              <li class="mr-4 inline-block">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="mr-2 -mt-1 inline-block" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M464 128H272l-54.63-54.63c-6-6-14.14-9.37-22.63-9.37H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V176c0-26.51-21.49-48-48-48zm0 272H48V112h140.12l54.63 54.63c6 6 14.14 9.37 22.63 9.37H464v224z"></path></svg>
                
              </li>
            </ul>
          </div>

          <div class="content">
            <div id="search" class="ml-3 p-4 -mt-8"></div>
            <article id="article">
              <h1 id="chapter-1-introduction-to-rust-and-command-line-applications">Chapter 1: Introduction to Rust and Command Line Applications</h1>
<p>Why Rust is a good choice for building command line applications?
Rust is a great choice for building command line applications because of its safety guarantees, performance, and strong type system. Rust’s ownership model and memory safety features make it virtually impossible to have memory leaks, buffer overflows, or null pointer errors. This is especially important for command line applications that may deal with sensitive or critical data.</p>
<p>Additionally, Rust is known for its speed and efficiency. This is important for command line applications that may need to process large amounts of data quickly. Rust also provides a lot of powerful features for working with text, such as regular expressions, pattern matching, and string manipulation.</p>
<p>Finally, Rust’s strong type system helps catch errors at compile time, rather than runtime. This can save developers a lot of time and headaches in the long run, as they can catch errors early and ensure that their code is correct before deploying it.</p>
<p>Basic concepts and tools for building command line applications in Rust
To build command line applications in Rust, developers need to understand a few basic concepts and tools. Here are some of the most important ones:</p>
<ol>
<li>The <code>std::env</code> module: This module provides functionality for working with environment variables, command line arguments, and the current working directory. It is often used in Rust command line applications to parse arguments and set configuration options.</li>
<li>The <code>std::fs</code> module: This module provides functionality for working with the filesystem, such as reading and writing files, creating directories, and querying file metadata. It is often used in Rust command line applications to interact with files and directories on the user’s system.</li>
<li>The <code>structopt</code> crate: This crate provides a simple and elegant way to define and parse command line arguments in Rust. It uses Rust’s <code>derive</code> macro system to generate code that can handle common argument types, such as strings, integers, and booleans.</li>
<li>The <code>clap</code> crate: This crate is similar to <code>structopt</code>, but provides more advanced features for working with complex command line interfaces. It supports subcommands, command aliases, and custom help messages, among other things.</li>
<li>The <code>std::io</code> module: This module provides functionality for working with input and output streams, such as reading from standard input, writing to standard output, and reading from files. It is often used in Rust command line applications to process input data and generate output.</li>
</ol>
<p>These tools and concepts are just the tip of the iceberg when it comes to building command line applications in Rust. However, they provide a solid foundation for developers to start building powerful and efficient command line tools.</p>
<h1 id="chapter-2-building-a-tail-command">Chapter 2: Building a Tail Command</h1>
<p>Overview of the tail command and its functionality
The <code>tail</code> command is a popular Unix/Linux command-line utility that allows users to display the last part of a file. It is commonly used to monitor log files or other files that are constantly being updated.</p>
<p>The basic syntax for the <code>tail</code> command is as follows:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #E06C75">tail</span><span style="color: #ABB2BF"> [</span><span style="color: #E06C75">options</span><span style="color: #ABB2BF">] [</span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">]</span></span></code></pre>
<p>Here are some of the most commonly used options for the <code>tail</code> command:</p>
<ul>
<li><code>-n &#x3C;num></code>: Displays the last <code>num</code> lines of the file. For example, <code>tail -n 10 file.txt</code> would display the last 10 lines of <code>file.txt</code>.</li>
<li><code>-f</code>: Follows the file and outputs any new lines as they are added. This is useful for monitoring log files or other files that are being updated in real time.</li>
<li><code>-c &#x3C;num></code>: Displays the last <code>num</code> bytes of the file. For example, <code>tail -c 100 file.txt</code> would display the last 100 bytes of <code>file.txt</code>.</li>
<li><code>-q</code>: Quiet mode. Suppresses the headers that are normally displayed when using <code>tail</code> on multiple files.</li>
<li><code>-v</code>: Verbose mode. Displays the headers that are normally suppressed when using <code>tail</code> on multiple files.</li>
</ul>
<p>In addition to these options, the <code>tail</code> command also supports some less commonly used options, such as <code>-n +&#x3C;num></code> (displays all lines starting from line <code>num</code>), <code>-s &#x3C;num></code> (sets the sleep interval for the <code>-f</code> option), and <code>-F</code> (same as <code>-f</code>, but follows the file even if it is renamed or rotated).</p>
<p>Overall, the <code>tail</code> command is a powerful and versatile tool for working with files on the command line. It is particularly useful for monitoring log files or other files that are constantly being updated, as it allows users to easily view the latest changes in the file.</p>
<p>Designing the Rust implementation of the tail command
To implement the <code>tail</code> command in Rust, we can use the <code>std::io</code> module to read files and <code>structopt</code> crate to parse command-line arguments. Here’s a basic implementation:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">prelude</span><span style="color: #ABB2BF">::*, </span><span style="color: #E5C07B">SeekFrom</span><span style="color: #ABB2BF">};</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">structopt</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">StructOpt</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">#[derive(</span><span style="color: #E5C07B">Debug</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">StructOpt</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #ABB2BF">#[structopt(name </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"tail"</span><span style="color: #ABB2BF">, about </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"Display the last part of a file"</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #C678DD">struct</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Opt</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> #[structopt(short </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"n"</span><span style="color: #ABB2BF">, default_value </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"10"</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">num_lines</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">usize</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> #[structopt(parse(from_os_str))]</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">path</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">PathBuf</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() -> </span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Result</span><span style="color: #ABB2BF">&#x3C;()> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">opt</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Opt</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">from_args</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">open</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">opt</span><span style="color: #ABB2BF">.path)?;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file_size</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">metadata</span><span style="color: #ABB2BF">()?.</span><span style="color: #61AFEF">len</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">buffer</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">vec!</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">0</span><span style="color: #E5C07B">u8</span><span style="color: #ABB2BF">; </span><span style="color: #E06C75">file_size</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">as</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">usize</span><span style="color: #ABB2BF">];</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">bytes_to_read</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">cmp</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">min</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file_size</span><span style="color: #ABB2BF">, (</span><span style="color: #E06C75">opt</span><span style="color: #ABB2BF">.num_lines * </span><span style="color: #D19A66">80</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">as</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">u64</span><span style="color: #ABB2BF">);</span><span style="color: #7F848E; font-style: italic"> // assuming average line length is 80 bytes</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">pos</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">seek</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">SeekFrom</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">End</span><span style="color: #ABB2BF">(-(</span><span style="color: #E06C75">bytes_to_read</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">as</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">i64</span><span style="color: #ABB2BF">)))?;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">read_exact</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">buffer</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">lines</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">from_utf8_lossy</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">buffer</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">lines</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">rev</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">take</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">opt</span><span style="color: #ABB2BF">.num_lines)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">collect</span><span style="color: #ABB2BF">::&#x3C;</span><span style="color: #E5C07B">Vec</span><span style="color: #ABB2BF">&#x3C;&#x26;</span><span style="color: #E5C07B">str</span><span style="color: #ABB2BF">>>()</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">join</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">lines</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Ok</span><span style="color: #ABB2BF">(())</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>In this implementation, we define a <code>Opt</code> struct using <code>StructOpt</code> to parse the command-line arguments. The <code>num_lines</code> field specifies the number of lines to display (defaulting to 10), and the <code>path</code> field specifies the path of the file to read.</p>
<p>We then open the file using <code>File::open</code> and read its metadata using <code>metadata()</code> to get the file size. We allocate a buffer of the same size as the file and read the last <code>num_lines * 80</code> bytes of the file into it using <code>read_exact</code> and <code>seek</code>. We assume that the average line length is 80 bytes for the purposes of this implementation.</p>
<p>We convert the buffer to a <code>String</code> using <code>String::from_utf8_lossy</code> and split it into lines using <code>lines()</code>. We reverse the lines using <code>rev()</code> and take the last <code>num_lines</code> lines using <code>take()</code>. We collect the lines into a <code>Vec&#x3C;&#x26;str></code> and join them using <code>join()</code> to get a single string with the last <code>num_lines</code> lines of the file.</p>
<p>Finally, we print the resulting string to standard output using <code>println!()</code>. The <code>?</code> operator is used throughout the implementation to propagate any errors that occur during file operations.</p>
<p>Reading and processing the input file
In the <code>tail</code> command, the input file is read and processed to extract the last few lines of the file. In Rust, we can use the <code>std::fs::File</code> module to read the contents of a file. Here’s how we can read the input file and extract the last few lines:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">BufRead</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">BufReader</span><span style="color: #ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">read_file</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">: &#x26;</span><span style="color: #E5C07B">str</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">num_lines</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">usize</span><span style="color: #ABB2BF">) -> </span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Result</span><span style="color: #ABB2BF">&#x3C;</span><span style="color: #E5C07B">Vec</span><span style="color: #ABB2BF">&#x3C;</span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">>> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">open</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">reader</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">BufReader</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">lines</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Vec</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">reader</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">lines</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">rev</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">take</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">num_lines</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">lines</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">line</span><span style="color: #ABB2BF">?);</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Ok</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">lines</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">into_iter</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">rev</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">collect</span><span style="color: #ABB2BF">())</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>In this code, we define a function <code>read_file</code> that takes two arguments: the path of the file to read and the number of lines to extract. We first open the file using <code>File::open</code> and create a <code>BufReader</code> around it to efficiently read the file. We then create a <code>Vec</code> to store the lines we want to extract.</p>
<p>We loop over the lines in the <code>BufReader</code>, reversing them using <code>rev()</code>, and take the first <code>num_lines</code> lines using <code>take()</code>. We push each line onto the <code>lines</code> vector using the <code>?</code> operator to propagate any errors that occur while reading the file.</p>
<p>Finally, we reverse the <code>lines</code> vector using <code>into_iter()</code> and <code>rev()</code> and collect it into a new <code>Vec&#x3C;String></code> using <code>collect()</code>. We return this vector as the result of the function.</p>
<p>Note that this implementation assumes that the input file is a text file containing UTF-8 encoded characters. If the input file contains binary data or is encoded using a different encoding, this code may not work correctly.</p>
<p>Implementing the tail functionality
To implement the <code>tail</code> functionality in Rust, we can use the <code>structopt</code> crate to parse command-line arguments and the <code>std::fs::File</code> and <code>std::io</code> modules to read and process files. Here’s a basic implementation:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">BufRead</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">BufReader</span><span style="color: #ABB2BF">};</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">structopt</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">StructOpt</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">#[derive(</span><span style="color: #E5C07B">Debug</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">StructOpt</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #ABB2BF">#[structopt(name </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"tail"</span><span style="color: #ABB2BF">, about </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"Display the last part of a file"</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #C678DD">struct</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Opt</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> #[structopt(short </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"n"</span><span style="color: #ABB2BF">, default_value </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"10"</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">num_lines</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">usize</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> #[structopt(parse(from_os_str))]</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">path</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">PathBuf</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() -> </span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Result</span><span style="color: #ABB2BF">&#x3C;()> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">opt</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Opt</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">from_args</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">lines</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">read_file</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">opt</span><span style="color: #ABB2BF">.path, </span><span style="color: #E06C75">opt</span><span style="color: #ABB2BF">.num_lines)?;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">lines</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Ok</span><span style="color: #ABB2BF">(())</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">read_file</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">: &#x26;</span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">path</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Path</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">num_lines</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">usize</span><span style="color: #ABB2BF">) -> </span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Result</span><span style="color: #ABB2BF">&#x3C;</span><span style="color: #E5C07B">Vec</span><span style="color: #ABB2BF">&#x3C;</span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">>> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">open</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">reader</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">BufReader</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">lines</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Vec</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">reader</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">lines</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">rev</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">take</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">num_lines</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">lines</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">line</span><span style="color: #ABB2BF">?);</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Ok</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">lines</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">into_iter</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">rev</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">collect</span><span style="color: #ABB2BF">())</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>In this implementation, we define a <code>Opt</code> struct using <code>StructOpt</code> to parse the command-line arguments. The <code>num_lines</code> field specifies the number of lines to display (defaulting to 10), and the <code>path</code> field specifies the path of the file to read.</p>
<p>We then call the <code>read_file</code> function to extract the last <code>num_lines</code> lines from the file. We iterate over the resulting <code>Vec&#x3C;String></code> and print each line to standard output using <code>println!()</code>.</p>
<p>The <code>read_file</code> function is the same as the one described in the previous answer. It takes a path and a number of lines to extract, reads the file using a <code>BufReader</code>, and returns a <code>Vec&#x3C;String></code> containing the last <code>num_lines</code> lines of the file.</p>
<p>Note that this implementation assumes that the input file is a text file containing UTF-8 encoded characters. If the input file contains binary data or is encoded using a different encoding, this code may not work correctly. Additionally, this implementation may not handle very large files efficiently, as it reads the entire file into memory before extracting the last few lines.</p>
<p>Outputting the results to the console
In the Rust implementation of the <code>tail</code> command we can output the results to the console using the <code>println!()</code> macro. Here’s an example of how to output the last <code>num_lines</code> lines of a file to the console:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() -> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Result</span><span style="color: #ABB2BF">&#x3C;()> {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Parse command line arguments using `structopt</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">opt</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Opt</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">from_args</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Read the last `num_lines` lines of the file</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">lines</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">read_file</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">opt</span><span style="color: #ABB2BF">.path, </span><span style="color: #E06C75">opt</span><span style="color: #ABB2BF">.num_lines)?;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Output the lines to the console</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">lines</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Ok</span><span style="color: #ABB2BF">(())</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>In this code, we use the <code>println!()</code> macro to output each line of the file to the console. The <code>{}</code> inside the <code>println!()</code> macro is a placeholder for the line we want to output.</p>
<p>Note that if we want to output the results to a file instead of the console, we can use the <code>std::fs::File</code> module to create a new file and the <code>std::io::Write</code> trait to write the lines to the file. Here’s an example of how to do this:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">BufRead</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">BufReader</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">Write</span><span style="color: #ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() -> </span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Result</span><span style="color: #ABB2BF">&#x3C;()> {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Parse command line arguments</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">args</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">Vec</span><span style="color: #ABB2BF">&#x3C;</span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">env</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">args</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">collect</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">filename</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> &#x26;</span><span style="color: #E06C75">args</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">];</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">num_lines</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">args</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">and_then</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">|</span><span style="color: #E06C75">n</span><span style="color: #56B6C2">|</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">n</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">parse</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">ok</span><span style="color: #ABB2BF">()).</span><span style="color: #61AFEF">unwrap_or</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">10</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Read the last `num_lines` lines of the file</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">open</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">filename</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">reader</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">BufReader</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">lines</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Vec</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">reader</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">lines</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">rev</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">take</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">num_lines</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">lines</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">line</span><span style="color: #ABB2BF">?);</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Write the lines to a new file</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">output_file</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">create</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"output.txt"</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">lines</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">into_iter</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">rev</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">writeln!</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">output_file</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"{}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Ok</span><span style="color: #ABB2BF">(())</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>In this code, we first parse the command line arguments to get the input filename and the number of lines to output. We then use the <code>File::open()</code> method to open the file, create a <code>BufReader</code> around it, and read the last <code>num_lines</code> lines of the file.</p>
<p>We then create a new file using the <code>File::create()</code> method and write the lines to the file using the <code>writeln!()</code> macro. The <code>writeln!()</code> macro is similar to the <code>println!()</code> macro, but writes the output to a file instead of the console.</p>
<p>Note that this implementation assumes that the input file is a text file containing UTF-8 encoded characters. If the input file contains binary data or is encoded using a different encoding, this code may not work correctly.</p>
<p>Testing the tail command
Testing is an important part of software development, as it helps ensure that the code works correctly and meets the requirements. In Rust, we can use the built-in testing framework to write unit tests for our <code>tail</code> command.</p>
<p>Here’s an example of how to write a unit test for the <code>read_file</code> function, which reads the last <code>num_lines</code> lines of a file:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #ABB2BF">#[cfg(test)]</span></span>
<span class="line"><span style="color: #C678DD">mod</span><span style="color: #ABB2BF"> tests {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B; font-style: italic">super</span><span style="color: #ABB2BF">::*;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> #[test]</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">test_read_file</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Create a temporary file for testing</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">tempfile</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">NamedTempFile</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">write!</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"line 1</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">line 2</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">line 3</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">line 4</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">line 5</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Read the last 3 lines of the file</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">lines</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">read_file</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">(), </span><span style="color: #D19A66">3</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Check that the lines are correct</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">assert_eq!</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">lines</span><span style="color: #ABB2BF">, </span><span style="color: #61AFEF">vec!</span><span style="color: #ABB2BF">[</span><span style="color: #98C379">"line 3"</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"line 4"</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"line 5"</span><span style="color: #ABB2BF">]);</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>In this code, we create a temporary file using the <code>tempfile</code> crate, write some test data to it, and then call the <code>read_file</code> function to read the last 3 lines of the file. We then use the <code>assert_eq!()</code> macro to check that the lines returned by <code>read_file</code> are correct.</p>
<p>We can similarly write unit tests for other parts of the <code>tail</code> command, such as the command line argument parsing and the output generation. By writing thorough unit tests, we can ensure that our <code>tail</code> command works correctly and is free of bugs.</p>
<h1 id="chapter-3-building-a-head-command">Chapter 3: Building a Head Command</h1>
<p>Overview of the head command and its functionality
The <code>head</code> command is a Unix command-line utility that is used to output the first part of files, i.e., it prints the first <code>n</code> lines of a file to standard output.</p>
<p>The <code>head</code> command is commonly used to display the first few lines of a large text file, allowing a user to quickly preview the contents of the file. By default, <code>head</code> prints the first 10 lines of a file, but this can be customized using command-line options.</p>
<p>The <code>head</code> command is similar in functionality to the <code>tail</code> command, which is used to output the last <code>n</code> lines of a file. However, while <code>tail</code> is commonly used to view the most recent entries in a log file or other data stream, <code>head</code> is more commonly used to preview the beginning of a file.</p>
<p>Designing the Rust implementation of the head command
To implement the <code>head</code> command in Rust, we can follow a similar approach as we did for the <code>tail</code> command. Here is an outline of the steps involved:</p>
<ol>
<li>Parse the command-line arguments using a crate like <code>clap</code>. We should allow the user to specify the number of lines to output, as well as the input file(s) to read from.</li>
<li>Open the input file(s) for reading. We can use the <code>File</code> struct from the <code>std::fs</code> module to open files, and the <code>BufReader</code> struct from the <code>std::io</code> module to efficiently read lines from the file.</li>
<li>Read the first <code>n</code> lines of the file(s), where <code>n</code> is the number of lines specified by the user. We can use a loop to read lines from the file(s) until we have read the desired number of lines.</li>
<li>Output the lines to the console. We can use the <code>println!()</code> macro to output each line to the console.</li>
<li>Close the input file(s).</li>
</ol>
<p>Here’s some example Rust code that demonstrates the basic structure of a <code>head</code> command implementation:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">BufRead</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">BufReader</span><span style="color: #ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Parse command-line arguments using `clap</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">clap</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">App</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"head"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"&#x3C;input-file>... 'The file(s) to read from'"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"-n, --lines &#x3C;lines> 'The number of lines to output'"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">get_matches</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Extract values from command-line arguments</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">files</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">Vec</span><span style="color: #ABB2BF">&#x3C;&#x26;</span><span style="color: #E5C07B">str</span><span style="color: #ABB2BF">> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">values_of</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"input-file"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">collect</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">num_lines</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">usize</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">value_of</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"lines"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap_or</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"10"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">parse</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Loop over input files and output first `num_lines` lines from each</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">files</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Open the file for reading and create a `BufReader</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">f</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">open</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">reader</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">BufReader</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">f</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Loop over the first `num_lines` lines and output them to the console</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">count</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">reader</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">lines</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">count</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">num_lines</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">break</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">count</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>In this code, we use the <code>clap</code> crate to parse command-line arguments, allowing the user to specify the number of lines to output and the input file(s) to read from. We then loop over the input files, read the first <code>num_lines</code> lines from each file, and output them to the console using the <code>println!()</code> macro.</p>
<p>Reading and processing the input file
To read and process the input file in the <code>head</code> command implementation, we can use the <code>BufReader</code> struct from the <code>std::io</code> module to efficiently read lines from the file. Here’s an updated version of the <code>head</code> command implementation that demonstrates how to read lines from the input file:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">BufRead</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">BufReader</span><span style="color: #ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Parse command-line arguments using `clap</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">clap</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">App</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"head"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"&#x3C;input-file>... 'The file(s) to read from'"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"-n, --lines &#x3C;lines> 'The number of lines to output'"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">get_matches</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Extract values from command-line arguments</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">files</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">Vec</span><span style="color: #ABB2BF">&#x3C;&#x26;</span><span style="color: #E5C07B">str</span><span style="color: #ABB2BF">> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">values_of</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"input-file"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">collect</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">num_lines</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">usize</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">value_of</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"lines"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap_or</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"10"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">parse</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Loop over input files and output first `num_lines` lines from each</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">files</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Open the file for reading and create a `BufReader</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">f</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">open</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">reader</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">BufReader</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">f</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Loop over the first `num_lines` lines and output them to the console</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">count</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">reader</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">lines</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">count</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">num_lines</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">break</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">count</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>In this code, we use the <code>File</code> struct from the <code>std::fs</code> module to open the input file for reading, and then we create a <code>BufReader</code> around the file handle to efficiently read lines from the file. We then loop over the first <code>num_lines</code> lines of the file, outputting each line to the console using the <code>println!()</code> macro.</p>
<p>Note that we use <code>line.unwrap()</code> to extract the <code>String</code> value of each line. This is because the <code>lines()</code> method returns an iterator over <code>Result&#x3C;String, std::io::Error></code>, where each <code>Ok</code> value is a <code>String</code> containing a line of text from the file. The <code>unwrap()</code> method is used to extract the <code>String</code> value from each <code>Ok</code> result, and will panic if the result is an <code>Err</code> value. In a real implementation, we would want to handle errors more gracefully.</p>
<p>Implementing the head functionality
To implement the <code>head</code> functionality in Rust, we can modify the <code>main</code> function of our <code>head</code> command implementation to output the first <code>num_lines</code> lines from each input file. Here’s an updated version of the <code>main</code> function that demonstrates how to do this:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">BufRead</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">BufReader</span><span style="color: #ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Parse command-line arguments using `clap</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">clap</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">App</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"head"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"&#x3C;input-file>... 'The file(s) to read from'"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"-n, --lines &#x3C;lines> 'The number of lines to output'"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">get_matches</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Extract values from command-line arguments</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">files</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">Vec</span><span style="color: #ABB2BF">&#x3C;&#x26;</span><span style="color: #E5C07B">str</span><span style="color: #ABB2BF">> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">values_of</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"input-file"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">collect</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">num_lines</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">usize</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">value_of</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"lines"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap_or</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"10"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">parse</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Loop over input files and output first `num_lines` lines from each</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">files</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Open the file for reading and create a `BufReader</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">f</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">open</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">reader</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">BufReader</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">f</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Loop over the first `num_lines` lines and output them to the console</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">count</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">reader</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">lines</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">count</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">num_lines</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">break</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">count</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>In this code, we first use <code>clap</code> to parse the command-line arguments and extract the values of the <code>input-file</code> and <code>lines</code> options. We then loop over each input file, opening it for reading using the <code>File</code> struct from the <code>std::fs</code> module and creating a <code>BufReader</code> around the file handle to efficiently read lines from the file. We then loop over the first <code>num_lines</code> lines of the file, outputting each line to the console using the <code>println!()</code> macro.</p>
<p>Note that this implementation is very similar to our implementation of the <code>tail</code> command, with the only difference being that we loop over the first <code>num_lines</code> lines of the file instead of the last <code>num_lines</code> lines.</p>
<p>Outputting the results to the console
To output the results of the <code>head</code> command to the console, we can use Rust’s <code>println!()</code> macro to print each line to the console. In the <code>main()</code> function of our <code>head</code> command implementation, we already have a loop that reads each line of the input file and outputs it to the console. Here’s the updated code that includes the <code>println!()</code> statement:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">BufRead</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">BufReader</span><span style="color: #ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Parse command-line arguments using `clap</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">clap</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">App</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"head"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"&#x3C;input-file>... 'The file(s) to read from'"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"-n, --lines &#x3C;lines> 'The number of lines to output'"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">get_matches</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Extract values from command-line arguments</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">files</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">Vec</span><span style="color: #ABB2BF">&#x3C;&#x26;</span><span style="color: #E5C07B">str</span><span style="color: #ABB2BF">> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">values_of</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"input-file"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">collect</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">num_lines</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">usize</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">value_of</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"lines"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap_or</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"10"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">parse</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Loop over input files and output first `num_lines` lines from each</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">files</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Open the file for reading and create a `BufReader</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">f</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">open</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">reader</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">BufReader</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">f</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Loop over the first `num_lines` lines and output them to the console</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">count</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">reader</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">lines</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">count</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">num_lines</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">break</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">count</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>This code uses the <code>println!()</code> macro to print each line of the input file to the console. The <code>{}</code> in the macro is a placeholder for the value of <code>line.unwrap()</code>, which is the contents of the current line of the input file. The output of this command will be the first <code>num_lines</code> lines of each input file.</p>
<p>Testing the head command
To test the <code>head</code> command, we can create a test file with some sample data and run the command on it with different arguments, verifying that the output is correct. Here’s an example test case:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #ABB2BF">#[test]</span></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">test_head</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Create a test file with some sample data</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">test_file_path</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"test_file.txt"</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">test_file</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">create</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">test_file_path</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">write!</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">test_file</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"1</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">2</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">3</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">4</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">5</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">6</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">7</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">8</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">9</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">10</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">test_file</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">flush</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Test that `head` outputs the first 5 lines of the test file</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">output</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">process</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Command</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"target/debug/head"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">args</span><span style="color: #ABB2BF">(&#x26;[&#x26;</span><span style="color: #E06C75">test_file_path</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"-n"</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"5"</span><span style="color: #ABB2BF">])</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">output</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">assert_eq!</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">from_utf8_lossy</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">output</span><span style="color: #ABB2BF">.stdout), </span><span style="color: #98C379">"1</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">2</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">3</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">4</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">5</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Test that `head` outputs the first 10 lines of the test file (i.e., the entire file)</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">output</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">process</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Command</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"target/debug/head"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">test_file_path</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">output</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">assert_eq!</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">from_utf8_lossy</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">output</span><span style="color: #ABB2BF">.stdout),</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #98C379">"1</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">2</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">3</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">4</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">5</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">6</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">7</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">8</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">9</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">10</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">"</span></span>
<span class="line"><span style="color: #ABB2BF"> );</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Clean up the test file</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">remove_file</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">test_file_path</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>This code creates a test file with 10 lines of data, then runs the <code>head</code> command on it with different arguments using Rust’s <code>std::process::Command</code> module. It then checks that the output of the command matches the expected output using the <code>assert_eq!()</code> macro. Finally, it cleans up the test file by deleting it. Running this test case should verify that the <code>head</code> command works correctly.</p>
<h1 id="chapter-4-building-a-du-command">Chapter 4: Building a Du Command</h1>
<p>Overview of the du command and its functionality
The <code>du</code> command is a Unix/Linux utility used to estimate file space usage. Its primary function is to report the amount of disk space used by a file or directory and its subdirectories. The command is useful in situations where you need to identify large files or directories that are taking up disk space, or to check the disk usage of a specific directory or file. It can also be used to generate a summary of disk usage for a set of files or directories. The <code>du</code> command provides several options that allow you to customize the output, such as specifying a depth for the directory tree to traverse, sorting the output by size, and displaying the sizes in different units.</p>
<p>Designing the Rust implementation of the du command
To implement the <code>du</code> command in Rust, we can follow these general steps:</p>
<ol>
<li>Parse the command line arguments to determine the target directory or file, as well as any additional options specified by the user.</li>
<li>Traverse the directory tree recursively, accumulating the sizes of all files and directories encountered.</li>
<li>Optionally sort the results by size, and format the output according to the user’s specified options.</li>
<li>Write the output to the console.</li>
</ol>
<p>Some of the options that we might want to support include:</p>
<ul>
<li><code>-h</code> or <code>--human-readable</code>: display sizes in human-readable format (e.g., “1.2K”, “2.3M”, etc.).</li>
<li><code>-c</code> or <code>--total</code>: display a grand total for all files and directories.</li>
<li><code>-d</code> or <code>--max-depth</code>: specify the maximum depth of the directory tree to traverse.</li>
<li><code>-s</code> or <code>--sort</code>: sort the output by size, either in ascending or descending order.</li>
</ul>
<p>By supporting these and other options, we can provide users with a flexible and powerful tool for analyzing disk usage.</p>
<p>Reading and processing the input directory
To implement the <code>du</code> command in Rust, we’ll need to recursively traverse the directory tree starting at the specified directory, and accumulate the sizes of all files and directories that we encounter. We can use Rust’s <code>std::fs</code> module to accomplish this.</p>
<p>Here’s an example implementation of the function that reads and processes the input directory:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::fs;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">process_directory</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">: &#x26;</span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">path</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">PathBuf</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">max_depth</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">i32</span><span style="color: #ABB2BF">) -> </span><span style="color: #E5C07B">u64</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">u64</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // If we've reached the maximum depth, return 0 to skip this directory and its children</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">max_depth</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_file</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // If the path is a file, return its size</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">metadata</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">len</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> } </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_dir</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // If the path is a directory, recursively process its children</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">read_dir</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry_path</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">process_directory</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">entry_path</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">max_depth</span><span style="color: #ABB2BF"> - </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">total_size</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>This function takes two arguments: a <code>PathBuf</code> representing the input directory or file, and an <code>i32</code> representing the maximum depth of the directory tree to traverse. It returns a <code>u64</code> representing the total size of all files and directories encountered.</p>
<p>The function first checks whether the input path is a file or a directory. If it’s a file, it simply returns the file’s size using <code>fs::metadata(&#x26;path).unwrap().len()</code>. If it’s a directory, it recursively processes its children by iterating over the entries returned by <code>fs::read_dir(&#x26;path).unwrap()</code>, and calling <code>process_directory()</code> on each child entry. The function accumulates the sizes of all files and directories encountered, and returns the total size.</p>
<p>The <code>max_depth</code> parameter is used to control the depth of the directory tree traversal. If <code>max_depth</code> is 0, the function immediately returns 0 without processing the input directory or its children. If <code>max_depth</code> is greater than 0, the function processes the input directory and its children, but decrements <code>max_depth</code> by 1 for each child, to ensure that we don’t traverse the tree beyond the specified depth.</p>
<p>Implementing the du functionality
Now that we have a function to read and process the input directory, we can implement the <code>du</code> functionality by parsing the command line arguments, calling the <code>process_directory()</code> function, and formatting the output as desired.</p>
<p>Here’s an example implementation:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::env;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">path</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">PathBuf</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">humansize</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">FileSize</span><span style="color: #ABB2BF">, file_size_opts};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">args</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">Vec</span><span style="color: #ABB2BF">&#x3C;</span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">env</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">args</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">collect</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Parse command line arguments</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">PathBuf</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">from</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"."</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">max_depth</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> -</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">human_readable</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">false</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">sort_order</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">SortOrder</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Descending</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">arg</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">args</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">iter</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">skip</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">match</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">arg</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">as_str</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #98C379">"-h"</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">|</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"--human-readable"</span><span style="color: #ABB2BF"> => </span><span style="color: #E06C75">human_readable</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #98C379">"-d"</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">|</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"--max-depth"</span><span style="color: #ABB2BF"> => {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">max_depth</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">args</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">args</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">iter</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">position</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">|</span><span style="color: #E06C75">x</span><span style="color: #56B6C2">|</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">x</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">arg</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">() + </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">parse</span><span style="color: #ABB2BF">::&#x3C;</span><span style="color: #E5C07B">i32</span><span style="color: #ABB2BF">>()</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">unwrap_or</span><span style="color: #ABB2BF">(-</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> },</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #98C379">"-s"</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">|</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"--sort"</span><span style="color: #ABB2BF"> => </span><span style="color: #E06C75">sort_order</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">SortOrder</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Ascending</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">_</span><span style="color: #ABB2BF"> => </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">PathBuf</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">from</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">arg</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Process directory and accumulate file sizes</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">process_directory</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">max_depth</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Format and output results</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">human_readable</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">file_size</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">file_size_opts</span><span style="color: #ABB2BF">::</span><span style="color: #D19A66">CONVENTIONAL</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #ABB2BF"> } </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">enum</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">SortOrder</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Ascending</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Descending</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">process_directory</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">: &#x26;</span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">path</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">PathBuf</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">max_depth</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">i32</span><span style="color: #ABB2BF">) -> </span><span style="color: #E5C07B">u64</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Implementation of process_directory function from previous step</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>This implementation uses Rust’s <code>std::env</code> module to parse command line arguments, and stores the relevant options (input path, maximum depth, human-readable output, and sort order) in variables. We use a <code>match</code> statement to check each argument and modify the appropriate variable.</p>
<p>Next, we call the <code>process_directory()</code> function with the specified input path and maximum depth, and accumulate the total size of all files and directories encountered.</p>
<p>Finally, we format and output the results using Rust’s <code>println!()</code> macro. If the <code>--human-readable</code> option was specified, we use the <code>humansize</code> crate to format the size in a human-readable format. Otherwise, we simply print the size as an integer.</p>
<p>This implementation also supports sorting the output by size, using an <code>enum</code> called <code>SortOrder</code> to represent the sort order (either ascending or descending). However, we have not yet implemented the sorting functionality itself.</p>
<p>Outputting the results to the console
To output the results of the <code>du</code> command to the console, we’ll need to format them in a readable way. We can accomplish this by using the <code>humansize</code> crate to format the file sizes, and the <code>tree_magic_mini</code> crate to determine the file types.</p>
<p>Here’s an example implementation:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::env;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">path</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">Path</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">PathBuf</span><span style="color: #ABB2BF">};</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::fs;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">humansize</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">FileSize</span><span style="color: #ABB2BF">, file_size_opts};</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">tree_magic_mini</span><span style="color: #ABB2BF">::from_filepath;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">args</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">Vec</span><span style="color: #ABB2BF">&#x3C;</span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">env</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">args</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">collect</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Parse command line arguments</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">PathBuf</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">from</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"."</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">max_depth</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> -</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">human_readable</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">false</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">sort_order</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">SortOrder</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Descending</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">arg</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">args</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">iter</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">skip</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">match</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">arg</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">as_str</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #98C379">"-h"</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">|</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"--human-readable"</span><span style="color: #ABB2BF"> => </span><span style="color: #E06C75">human_readable</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #98C379">"-d"</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">|</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"--max-depth"</span><span style="color: #ABB2BF"> => {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">max_depth</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">args</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">args</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">iter</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">position</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">|</span><span style="color: #E06C75">x</span><span style="color: #56B6C2">|</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">x</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">arg</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">() + </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">parse</span><span style="color: #ABB2BF">::&#x3C;</span><span style="color: #E5C07B">i32</span><span style="color: #ABB2BF">>()</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">unwrap_or</span><span style="color: #ABB2BF">(-</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> },</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #98C379">"-s"</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">|</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"--sort"</span><span style="color: #ABB2BF"> => </span><span style="color: #E06C75">sort_order</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">SortOrder</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Ascending</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">_</span><span style="color: #ABB2BF"> => </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">PathBuf</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">from</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">arg</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Process directory and accumulate file sizes</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">process_directory</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">max_depth</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">sort_order</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Format and output results</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">human_readable</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">file_size</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">file_size_opts</span><span style="color: #ABB2BF">::</span><span style="color: #D19A66">CONVENTIONAL</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #ABB2BF"> } </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">print_results</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">to_str</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">enum</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">SortOrder</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Ascending</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Descending</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">process_directory</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">: &#x26;</span><span style="color: #E5C07B">Path</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">max_depth</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">i32</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">current_depth</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">i32</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">sort_order</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">SortOrder</span><span style="color: #ABB2BF">) -> </span><span style="color: #E5C07B">u64</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">max_depth</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">>=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">&#x26;&#x26;</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">current_depth</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">></span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">max_depth</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">read_dir</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">metadata</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">metadata</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file_type</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">from_filepath</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">metadata</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_file</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">metadata</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">len</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> } </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">metadata</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_dir</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">size</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">process_directory</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">max_depth</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">current_depth</span><span style="color: #ABB2BF"> + </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">sort_order</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">size</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file_type</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"text/plain"</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">to_str</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">sort_order</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">SortOrder</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Ascending</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}</span><span style="color: #56B6C2">\t</span><span style="color: #98C379">{}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">to_str</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">total_size</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">print_results</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF">: &#x26;</span><span style="color: #E5C07B">u64</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">: &#x26;</span><span style="color: #E5C07B">str</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}</span><span style="color: #56B6C2">\t</span><span style="color: #98C379">{}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">file_size</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">file_size_opts</span><span style="color: #ABB2BF">::</span><span style="color: #D19A66">CONVENTIONAL</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">(), </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>This implementation includes a new function called <code>print_results()</code> which formats and outputs the results to the console. It takes the total size of the directory as a <code>u64</code> and the path to the directory as a string, and uses the <code>humansize</code> crate to format the size in a human-readable format. The results are printed as a single line, with the size followed by the path.</p>
<p>The <code>process_directory()</code> function has also been modified to print the path to any plain text files it encounters, using the <code>tree_magic_mini</code> crate to determine the file type. Additionally, if the <code>--sort</code> option was specified as <code>ascending</code>, the function will print the size and path of each directory as it encounters it.</p>
<p>Testing the du command
Once the implementation of the <code>du</code> command is complete, it’s important to test it to ensure that it works as expected. Here are some tests that can be run:</p>
<ol>
<li>Test with a directory that contains subdirectories: create a test directory that contains several subdirectories with varying sizes. Run the <code>du</code> command on this directory and compare the output with the expected output.</li>
<li>Test with a directory that contains only files: create a test directory that contains only files with varying sizes. Run the <code>du</code> command on this directory and compare the output with the expected output.</li>
<li>Test with a single file: create a test file with a known size and run the <code>du</code> command on this file. Compare the output with the expected output.</li>
<li>Test with a hidden directory: create a hidden directory with subdirectories and files inside it. Run the <code>du</code> command on this hidden directory and ensure that the output includes the hidden directory and its contents.</li>
<li>Test with a directory containing a symbolic link: create a symbolic link to a directory inside the test directory, and then run the <code>du</code> command on the test directory. Ensure that the output includes the symbolic link and its target.</li>
<li>Test with a directory that the user doesn’t have permission to read: create a test directory with restricted permissions that the user running the <code>du</code> command doesn’t have permission to read. Ensure that the <code>du</code> command fails gracefully and provides a useful error message.</li>
</ol>
<p>These tests can be automated using a testing framework like Rust’s built-in <code>assert_eq!</code> macro or a third-party crate like <code>assert_cmd</code>. By thoroughly testing the <code>du</code> command, we can ensure that it’s robust and reliable for use in real-world scenarios.</p>
<h1 id="chapter-5-building-a-df-command">Chapter 5: Building a Df Command</h1>
<p>Overview of the df command and its functionality
The <code>df</code> command is a standard Unix utility that is used to display information about the file system on a Linux or Unix system. The <code>df</code> command reports the file system disk space usage in human-readable format. It shows the total size, used space, and available space on all mounted file systems.</p>
<p>The output of the <code>df</code> command is displayed in columns and contains the following information for each mounted file system:</p>
<ul>
<li>File system device or partition</li>
<li>Total size of the file system in kilobytes, megabytes, or gigabytes</li>
<li>Used space in kilobytes, megabytes, or gigabytes</li>
<li>Available space in kilobytes, megabytes, or gigabytes</li>
<li>Used percentage of the file system</li>
</ul>
<p>The <code>df</code> command can also be used to display information about a specific file system or a group of file systems by specifying their mount points as arguments.</p>
<p>The <code>df</code> command is useful for system administrators who need to monitor the disk space usage on a system and identify any file systems that are running low on space. It can be used to ensure that file systems are not running out of space, and to identify any potential issues that may need to be addressed to avoid data loss or system downtime.</p>
<p>Designing the Rust implementation of the df command
To design the Rust implementation of the <code>df</code> command, we can follow a similar approach to the other commands we’ve discussed. Here are the high-level steps we can take:</p>
<ol>
<li>Parse command line arguments: The <code>df</code> command can take one or more mount points as arguments. We can use Rust’s built-in <code>clap</code> library to parse and validate the command line arguments.</li>
<li>Retrieve file system information: We can use Rust’s <code>std::fs::metadata</code> function to retrieve information about the file system on which the given mount points are located. This function returns a <code>Metadata</code> struct, which contains information about the file system’s size, used space, and available space.</li>
<li>Format output: We can format the output of the <code>df</code> command using Rust’s <code>format!</code> macro or a third-party crate like <code>prettytable</code>. The output should include the file system device or partition, total size, used space, available space, and used percentage of each mounted file system.</li>
<li>Display output: We can use Rust’s <code>println!</code> macro to display the formatted output to the console.</li>
</ol>
<p>By following these steps, we can implement a Rust version of the <code>df</code> command that provides the same functionality as the standard Unix <code>df</code> command.</p>
<p>Reading and processing the input file system
In the case of the <code>df</code> command, we don’t need to read an input file, but rather retrieve information about the mounted file systems on the system. We can use Rust’s <code>std::fs::metadata</code> function to retrieve the information we need.</p>
<p>Here’s some sample Rust code that demonstrates how to use <code>std::fs::metadata</code> to retrieve information about a file system:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">path</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Path</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Path</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"/mnt/myfilesystem"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">metadata</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">match</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">metadata</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Ok</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">m</span><span style="color: #ABB2BF">) => </span><span style="color: #E06C75">m</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Err</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">) => {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">eprintln!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Error: {}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">metadata</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">total_space</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">used_space</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">metadata</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">total_space</span><span style="color: #ABB2BF">() - </span><span style="color: #E06C75">metadata</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">available_space</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">available_space</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">metadata</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">available_space</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">used_percent</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">used_space</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">as</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">f32</span><span style="color: #ABB2BF"> / </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">as</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">f32</span><span style="color: #ABB2BF"> * </span><span style="color: #D19A66">100.0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Filesystem: {}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">display</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Total space: {:.2} GB"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">as</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">f32</span><span style="color: #ABB2BF"> / </span><span style="color: #D19A66">1_000_000_000.0</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Used space: {:.2} GB"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">used_space</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">as</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">f32</span><span style="color: #ABB2BF"> / </span><span style="color: #D19A66">1_000_000_000.0</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Available space: {:.2} GB"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">available_space</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">as</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">f32</span><span style="color: #ABB2BF"> / </span><span style="color: #D19A66">1_000_000_000.0</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Used percent: {:.2}%"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">used_percent</span><span style="color: #ABB2BF">);</span></span></code></pre>
<p>In this code, we first create a <code>Path</code> object for the mount point we want to retrieve information about. We then call <code>std::fs::metadata</code> to retrieve a <code>Metadata</code> object for the file system.</p>
<p>We use the <code>total_space</code> and <code>available_space</code> methods of the <code>Metadata</code> struct to retrieve the total and available space on the file system, respectively. We calculate the used space and percentage of used space by subtracting the available space from the total space and dividing by the total space, respectively.</p>
<p>Finally, we use <code>println!</code> to output the information to the console in a human-readable format.</p>
<p>Implementing the df functionality
To implement the <code>df</code> functionality, we can use the code we wrote for reading and processing the file system in the previous section, and wrap it in a loop that goes through all the mounted file systems on the system. Here’s some sample Rust code that demonstrates how to do this:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">DirEntry</span><span style="color: #ABB2BF">};</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::io;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">path</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">Path</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">PathBuf</span><span style="color: #ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">process_dir_entry</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">DirEntry</span><span style="color: #ABB2BF">) -> </span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Result</span><span style="color: #ABB2BF">&#x3C;</span><span style="color: #E5C07B">u64</span><span style="color: #ABB2BF">> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">metadata</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">metadata</span><span style="color: #ABB2BF">()?;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Ok</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">metadata</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">total_space</span><span style="color: #ABB2BF">())</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">walk_dir</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">: &#x26;</span><span style="color: #E5C07B">Path</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF">: &#x26;</span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">u64</span><span style="color: #ABB2BF">) -> </span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Result</span><span style="color: #ABB2BF">&#x3C;()> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">read_dir</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">)? {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">?;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">metadata</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">metadata</span><span style="color: #ABB2BF">()?;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">metadata</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_dir</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">walk_dir</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">(), </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF"> } </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> *</span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">process_dir_entry</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Ok</span><span style="color: #ABB2BF">(())</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">u64</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">mount_points</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">nix</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">mount</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">getmntent</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">MntIter</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">mount_point</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">mount_points</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">path_buf</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">PathBuf</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">from</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">mount_point</span><span style="color: #ABB2BF">.dir);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">path_buf</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">as_path</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">walk_dir</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">, &#x26;</span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">used_space</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF"> - </span><span style="color: #E06C75">mount_point</span><span style="color: #ABB2BF">.f_blocks * </span><span style="color: #E06C75">mount_point</span><span style="color: #ABB2BF">.bsize;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">available_space</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">mount_point</span><span style="color: #ABB2BF">.f_bfree * </span><span style="color: #E06C75">mount_point</span><span style="color: #ABB2BF">.bsize;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">used_percent</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">used_space</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">as</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">f32</span><span style="color: #ABB2BF"> / </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">as</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">f32</span><span style="color: #ABB2BF"> * </span><span style="color: #D19A66">100.0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Filesystem: {}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">mount_point</span><span style="color: #ABB2BF">.dir);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Total space: {:.2} GB"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">as</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">f32</span><span style="color: #ABB2BF"> / </span><span style="color: #D19A66">1_000_000_000.0</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Used space: {:.2} GB"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">used_space</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">as</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">f32</span><span style="color: #ABB2BF"> / </span><span style="color: #D19A66">1_000_000_000.0</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Available space: {:.2} GB"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">available_space</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">as</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">f32</span><span style="color: #ABB2BF"> / </span><span style="color: #D19A66">1_000_000_000.0</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Used percent: {:.2}%"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">used_percent</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>In this code, we first retrieve an iterator of mounted file systems using the <code>nix::mount::getmntent::MntIter</code> function. We then loop through all the mounted file systems, retrieving the path of each mount point and passing it to the <code>walk_dir</code> function we wrote in the previous section.</p>
<p>We calculate the total size of the file system by adding up the sizes of all the files in the file system using the <code>process_dir_entry</code> function we wrote earlier. We then use the information in the <code>mntent</code> struct to calculate the used and available space on the file system, as well as the percentage of used space.</p>
<p>Finally, we use <code>println!</code> to output the information to the console in a human-readable format.</p>
<p>Outputting the results to the console
To output the results of the <code>df</code> command to the console, we can use the <code>println!()</code> macro to print the values of the filesystem statistics to the console in a formatted way.</p>
<p>Here is an example of how we can format and print the output:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">print_filesystem_stats</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">stats</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">FilesystemStats</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">size</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">stats</span><span style="color: #ABB2BF">.total_size / (</span><span style="color: #D19A66">1024</span><span style="color: #ABB2BF"> * </span><span style="color: #D19A66">1024</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">used</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">stats</span><span style="color: #ABB2BF">.used_size / (</span><span style="color: #D19A66">1024</span><span style="color: #ABB2BF"> * </span><span style="color: #D19A66">1024</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">available</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">stats</span><span style="color: #ABB2BF">.available_size / (</span><span style="color: #D19A66">1024</span><span style="color: #ABB2BF"> * </span><span style="color: #D19A66">1024</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">used_percentage</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> ((</span><span style="color: #E06C75">stats</span><span style="color: #ABB2BF">.used_size </span><span style="color: #C678DD">as</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">f64</span><span style="color: #ABB2BF"> / </span><span style="color: #E06C75">stats</span><span style="color: #ABB2BF">.total_size </span><span style="color: #C678DD">as</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">f64</span><span style="color: #ABB2BF">) * </span><span style="color: #D19A66">100.0</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">as</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">u32</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #98C379">"{:&#x3C;10} {:>10} {:>10} {:>10} {}"</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">stats</span><span style="color: #ABB2BF">.filesystem,</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">size</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">used</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">available</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">used_percentage</span></span>
<span class="line"><span style="color: #ABB2BF"> );</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>In this example, we first calculate the total size, used size, and available size of the filesystem in megabytes. We also calculate the percentage of used space as an integer.</p>
<p>Then we use the <code>println!()</code> macro to print the formatted output to the console. The format string <code>"{:&#x3C;10} {:>10} {:>10} {:>10} {}"</code> specifies the layout of the output. The <code>&#x3C;</code> and <code>></code> characters specify left and right alignment, respectively, and the numbers specify the width of each field.</p>
<p>We pass the values of the filesystem name, total size, used size, available size, and used percentage as arguments to the <code>println!()</code> macro.</p>
<p>This example assumes that the <code>FilesystemStats</code> struct has the following fields:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">struct</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">FilesystemStats</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">filesystem</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">u64</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">used_size</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">u64</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">available_size</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">u64</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>Testing the df command
To test the <code>df</code> command, we can use the <code>assert_eq!()</code> macro to compare the output of the command to the expected output.</p>
<p>Here is an example test function for the <code>df</code> command:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #ABB2BF">#[test]</span></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">test_df_command</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">stats</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">vec!</span><span style="color: #ABB2BF">[</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">FilesystemStats</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">filesystem</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">"/dev/sda1"</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">to_string</span><span style="color: #ABB2BF">(),</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">1000000000</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">used_size</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">500000000</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">available_size</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">500000000</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> },</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">FilesystemStats</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">filesystem</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">"/dev/sdb1"</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">to_string</span><span style="color: #ABB2BF">(),</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">2000000000</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">used_size</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">1000000000</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">available_size</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">1000000000</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> },</span></span>
<span class="line"><span style="color: #ABB2BF"> ];</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">expected_output</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"Filesystem Size(GB) Used(GB) Avail(GB) Use%</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">/dev/sda1 954 477 477 50%</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">/dev/sdb1 1907 953 953 50%</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">"</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">assert_eq!</span><span style="color: #ABB2BF">(</span><span style="color: #61AFEF">df_command</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">stats</span><span style="color: #ABB2BF">), </span><span style="color: #E06C75">expected_output</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>In this example, we create a vector of <code>FilesystemStats</code> structs to use as input for the <code>df</code> command. We then define a string variable <code>expected_output</code> that contains the expected output of the command.</p>
<p>We use the <code>assert_eq!()</code> macro to compare the output of the <code>df_command()</code> function with the expected output. If the two values are equal, the test passes. If they are not equal, the test fails.</p>
<h1 id="chapter-6-building-a-rm-command">Chapter 6: Building a Rm Command</h1>
<p>Overview of the rm command and its functionality
The <code>rm</code> command in Linux is used to remove files or directories. It can be used to delete individual files, multiple files, or entire directories and their contents.</p>
<p>The basic syntax of the <code>rm</code> command is as follows:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #E06C75">rm</span><span style="color: #ABB2BF"> [</span><span style="color: #D19A66">OPTION</span><span style="color: #ABB2BF">]... </span><span style="color: #D19A66">FILE</span><span style="color: #ABB2BF">...</span></span></code></pre>
<p>Where <code>FILE</code> is the name of the file(s) or directory to be removed, and <code>[OPTION]</code> is an optional flag that modifies the behavior of the command.</p>
<p>Some common options for the <code>rm</code> command are:</p>
<ul>
<li><code>-r</code>: removes directories and their contents recursively</li>
<li><code>-f</code>: force removal without prompting for confirmation</li>
<li><code>-i</code>: prompt the user for confirmation before deleting each file</li>
</ul>
<p>It’s important to use the <code>rm</code> command with caution, as it can permanently delete files and directories without any way to recover them.</p>
<p>Designing the Rust implementation of the rm command
The Rust implementation of the <code>rm</code> command will involve reading the command line arguments, processing them to determine the files and directories to delete, and then deleting them using the <code>std::fs::remove_file()</code> and <code>std::fs::remove_dir_all()</code> functions.</p>
<p>Here is a rough outline of the steps involved in designing the Rust implementation of the <code>rm</code> command:</p>
<ol>
<li>Parse the command line arguments using the <code>clap</code> crate.</li>
<li>Determine whether the <code>-r</code> (recursive) option was specified. If it was, delete directories and their contents recursively using the <code>std::fs::remove_dir_all()</code> function. If it was not, delete files using the <code>std::fs::remove_file()</code> function.</li>
<li>If the <code>-i</code> (interactive) option was specified, prompt the user for confirmation before deleting each file or directory.</li>
<li>If the <code>-f</code> (force) option was specified, delete files and directories without prompting for confirmation.</li>
</ol>
<p>Overall, the Rust implementation of the <code>rm</code> command will be similar to the Unix implementation, with some additional safety features and error handling.</p>
<p>Reading and processing the input file or directory
In the Rust implementation of the <code>rm</code> command, the input will be the name(s) of the file(s) or directory(ies) to be deleted, passed as command line arguments.</p>
<p>To process the input, we can use the <code>clap</code> crate to parse the command line arguments and extract the filenames and options. Here’s an example of how to use <code>clap</code> to parse the command line arguments:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">clap</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">App</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">App</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"rm"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"FILES"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">multiple</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">required</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"The files or directories to delete"</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"recursive"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">short</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"r"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Delete directories and their contents recursively"</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"force"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">short</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"f"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Delete files without prompting for confirmation"</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"interactive"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">short</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"i"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Prompt before deleting each file or directory"</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">get_matches</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">filenames</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">values_of</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"FILES"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">recursive</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_present</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"recursive"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">force</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_present</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"force"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">interactive</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_present</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"interactive"</span><span style="color: #ABB2BF">);</span></span></code></pre>
<p>This code defines the command line arguments for the <code>rm</code> command using the <code>Arg</code> struct from <code>clap</code>, and then parses the arguments using the <code>App</code> struct. The <code>values_of</code> method is used to extract the filenames, and the <code>is_present</code> method is used to determine whether each option was specified.</p>
<p>Once we have the filenames and options, we can use them to delete the files or directories as needed. We’ll cover this in more detail in the next step.</p>
<p>Implementing the rm functionality
To implement the <code>rm</code> functionality in Rust, we’ll use the <code>std::fs</code> module to delete the files or directories specified in the command line arguments. We’ll also need to use the <code>std::io</code> module to handle any errors that occur during the deletion process.</p>
<p>Here’s an example implementation of the <code>rm</code> command:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::fs;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::io;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">remove_file_or_dir</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">: &#x26;</span><span style="color: #E5C07B">str</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">recursive</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">bool</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">force</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">bool</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">interactive</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">bool</span><span style="color: #ABB2BF">) -> </span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Result</span><span style="color: #ABB2BF">&#x3C;()> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">metadata</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">metadata</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">metadata</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_dir</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">recursive</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entries</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">read_dir</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entries</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry_path</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">?.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry_str</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry_path</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">to_str</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">remove_file_or_dir</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">entry_str</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">recursive</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">force</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">interactive</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> } </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">!</span><span style="color: #E06C75">force</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">&#x26;&#x26;</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">interactive</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">response</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">ask_for_confirmation</span><span style="color: #ABB2BF">(</span><span style="color: #61AFEF">format!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"rm: remove directory '{}'?"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">));</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">!</span><span style="color: #E06C75">response</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Ok</span><span style="color: #ABB2BF">(());</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">remove_dir</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF"> } </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">!</span><span style="color: #E06C75">force</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">&#x26;&#x26;</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">interactive</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">response</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">ask_for_confirmation</span><span style="color: #ABB2BF">(</span><span style="color: #61AFEF">format!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"rm: remove file '{}'?"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">));</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">!</span><span style="color: #E06C75">response</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Ok</span><span style="color: #ABB2BF">(());</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">remove_file</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Ok</span><span style="color: #ABB2BF">(())</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">ask_for_confirmation</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">prompt</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">) -> </span><span style="color: #E5C07B">bool</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">input</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">print!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{} "</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">prompt</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">stdout</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">flush</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">stdin</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">read_line</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">input</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">response</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">input</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">trim</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">to_lowercase</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">response</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"y"</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">||</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">response</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"yes"</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() -> </span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Result</span><span style="color: #ABB2BF">&#x3C;()> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">App</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"rm"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"FILES"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">multiple</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">required</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"The files or directories to delete"</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"recursive"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">short</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"r"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Delete directories and their contents recursively"</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"force"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">short</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"f"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Delete files without prompting for confirmation"</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"interactive"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">short</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"i"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Prompt before deleting each file or directory"</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">get_matches</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">filenames</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">values_of</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"FILES"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">recursive</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_present</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"recursive"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">force</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_present</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"force"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">interactive</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_present</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"interactive"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">filename</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">filenames</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">remove_file_or_dir</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">filename</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">recursive</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">force</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">interactive</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Ok</span><span style="color: #ABB2BF">(())</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>This implementation defines a <code>remove_file_or_dir</code> function that takes the path of a file or directory, as well as the <code>recursive</code>, <code>force</code>, and <code>interactive</code> options, and attempts to delete the file or directory. If the <code>recursive</code> option is specified and the path is a directory, the function recursively deletes the contents of the directory before deleting the directory itself. If the <code>force</code> option is not specified and the <code>interactive</code> option is specified, the function prompts the user for confirmation before deleting the file or directory.</p>
<p>The <code>ask_for_confirmation</code> function is a helper function that prints a prompt to the console and waits for the user to input a “y” or “n” response.</p>
<p>In the <code>main</code> function, we use <code>clap</code> to parse the command line arguments, and then loop through the filenames and call the <code>remove_file_or_dir</code> function for each one.</p>
<p>Note that we’re using the <code>?</code> operator throughout the code to propagate any errors that occur during the deletion process. This is a convenient way to handle errors in Rust, and it’s similar to the <code>try!</code> macro in Rust.</p>
<p>Outputting the results to the console
The <code>rm</code> command doesn’t typically output any results to the console unless there is an error. If the command is successful, it simply deletes the specified file or directory without displaying any output.</p>
<p>However, in our implementation, we display a success message if the deletion is successful and an error message if there is an error.</p>
<p>For example, if the <code>rm</code> command is run with a valid file argument, the output would be:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #E5C07B">Deleted</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">.txt</span></span></code></pre>
<p>If the <code>rm</code> command is run with a valid directory argument and the user confirms the deletion, the output would be:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #E5C07B">Are</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">you</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">sure</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">you</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">want</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">to</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">delete</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">directory</span><span style="color: #ABB2BF">? (</span><span style="color: #E06C75">y</span><span style="color: #ABB2BF">/</span><span style="color: #E06C75">n</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #E06C75">y</span></span>
<span class="line"><span style="color: #E5C07B">Deleted</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">directory</span></span></code></pre>
<p>If there is an error deleting the file or directory, the output would be:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #E5C07B">Error</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">No</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">such</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">or</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">directory</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">os</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">error</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">)</span></span></code></pre>
<p>Testing the rm command
To test the <code>rm</code> command, we can create a test file or directory and attempt to delete it using our implementation. We can then verify that the file or directory has been successfully deleted or not.</p>
<p>For example, let’s say we create a test file named <code>test.txt</code> in our current directory using the following command:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #E06C75">echo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"This is a test file"</span><span style="color: #ABB2BF"> > </span><span style="color: #E06C75">test</span><span style="color: #ABB2BF">.txt</span></span></code></pre>
<p>We can then run our <code>rm</code> command implementation with the following command:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #E06C75">rm</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">test</span><span style="color: #ABB2BF">.txt</span></span></code></pre>
<p>If the file is successfully deleted, the output would be:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #E5C07B">Deleted</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">test</span><span style="color: #ABB2BF">.txt</span></span></code></pre>
<p>We can then verify that the file has been deleted by running the <code>ls</code> command and checking if the file is present or not:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #E06C75">ls</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">test</span><span style="color: #ABB2BF">.txt</span></span></code></pre>
<p>If the file has been successfully deleted, the output would be:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #E06C75">yaml</span><span style="color: #ABB2BF">`</span><span style="color: #E06C75">ls</span><span style="color: #ABB2BF">: </span><span style="color: #E06C75">cannot</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">access</span><span style="color: #ABB2BF"> '</span><span style="color: #E5C07B">test</span><span style="color: #ABB2BF">.txt</span><span style="color: #98C379">': No such file or directory</span></span></code></pre>
<p>Similarly, we can test the <code>rm</code> command implementation with a test directory and verify that it has been deleted successfully or not.</p>
<h1 id="chapter-7-building-a-touch-command">Chapter 7: Building a Touch Command</h1>
<p>Overview of the touch command and its functionality
The <code>touch</code> command is a simple command-line utility used to create an empty file or update the modification and access time of an existing file without changing its content.</p>
<p>The basic functionality of the <code>touch</code> command is to create a new file with the specified name if it does not already exist. If the file already exists, it updates the file’s access and modification times to the current time.</p>
<p>The <code>touch</code> command is commonly used in shell scripts to create files with a specific name, and to update the modification time of a file after certain operations have been performed on it.</p>
<p>Some common use cases of the <code>touch</code> command include:</p>
<ul>
<li>Creating a new empty file with a specific name</li>
<li>Updating the modification and access time of an existing file</li>
<li>Updating the modification and access time of multiple files at once, using wildcards</li>
</ul>
<p>In summary, the <code>touch</code> command is a simple utility that is used to create or update the access and modification times of files.</p>
<p>Designing the Rust implementation of the touch command
To implement the <code>touch</code> command in Rust, we can follow these basic steps:</p>
<ol>
<li>Parse the command-line arguments to determine the name of the file to be created or updated, and any optional arguments.</li>
<li>Use the <code>Path</code> and <code>File</code> structs from the Rust standard library to check if the file already exists, and create it if it does not exist.</li>
<li>Update the modification and access time of the file using the <code>std::fs::set_times</code> function from the Rust standard library.</li>
<li>Print any relevant output or error messages to the console.</li>
</ol>
<p>Here is a code snippet that outlines the basic structure of the <code>touch</code> command implementation in Rust:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">};</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">Write</span><span style="color: #ABB2BF">};</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">path</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Path</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">time</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">SystemTime</span><span style="color: #ABB2BF">, UNIX_EPOCH};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() -> </span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Result</span><span style="color: #ABB2BF">&#x3C;()> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">args</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">Vec</span><span style="color: #ABB2BF">&#x3C;</span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">env</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">args</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">collect</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Parse command-line arguments</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">filename</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> &#x26;</span><span style="color: #E06C75">args</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">];</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Check if file exists, and create it if it does not</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Path</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">filename</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">!</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">exists</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">create</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">filename</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Update modification and access time</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">system_time</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">SystemTime</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">now</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file_time</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">system_time</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">duration_since</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">UNIX_EPOCH</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">times</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #E06C75">file_time</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">file_time</span><span style="color: #ABB2BF">];</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">set_times</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">filename</span><span style="color: #ABB2BF">, &#x26;</span><span style="color: #E06C75">times</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Print success message</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">writeln!</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">stdout</span><span style="color: #ABB2BF">(), </span><span style="color: #98C379">"File {} has been created or updated"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">filename</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Ok</span><span style="color: #ABB2BF">(())</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>This Rust code parses the command-line argument to get the name of the file to create or update. It then checks if the file exists, and creates it if it does not exist. Finally, it updates the modification and access times of the file and prints a success message to the console.</p>
<p>Reading and processing the input file
Since the touch command operates on files, it expects an input file name as an argument. The first step in implementing the touch command is to read and process the input file.</p>
<p>To do this, we can use the std::fs crate in Rust. This crate provides functions for working with files and directories. In particular, we will use the File struct to represent the input file.</p>
<p>We can start by checking if the input file exists. If it does not exist, we will create it using the File::create function. If it does exist, we will update its modification time using the std::fs::set_mtime function.</p>
<p>Here is some sample code to read and process the input file:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">prelude</span><span style="color: #ABB2BF">::*;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">time</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">SystemTime</span><span style="color: #ABB2BF">, UNIX_EPOCH};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">touch_file</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file_name</span><span style="color: #ABB2BF">: &#x26;</span><span style="color: #E5C07B">str</span><span style="color: #ABB2BF">) -> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Result</span><span style="color: #ABB2BF">&#x3C;()> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">open</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file_name</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">match</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Ok</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">f</span><span style="color: #ABB2BF">) => {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Update modification time</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">now</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">SystemTime</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">now</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">duration_since</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">UNIX_EPOCH</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">expect</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Time went backwards"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">as_secs</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">atime</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">now</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">mtime</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">now</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">set_times</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">file_name</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">time</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">SystemTime</span><span style="color: #ABB2BF">::</span><span style="color: #D19A66">UNIX_EPOCH</span><span style="color: #ABB2BF"> + </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">time</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Duration</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">from_secs</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">mtime</span><span style="color: #ABB2BF">))?;</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Err</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">_</span><span style="color: #ABB2BF">) => {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Create new file</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">f</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">create</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file_name</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Ok</span><span style="color: #ABB2BF">(())</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>In this code, we first try to open the input file using the File::open function. If the file exists, this function returns a Result containing the file handle. We use a match statement to handle this case.</p>
<p>If the file does not exist, the File::open function returns an error. In this case, we create a new file using the File::create function.</p>
<p>Once we have the file handle, we can update its modification time using the std::fs::set_times function. We use the current system time to update the modification time of the file.</p>
<p>Note that the set_times function takes the file name as a string, not a file handle. We need to convert the file handle to a string using the .to_str() method.</p>
<p>This code snippet is just a starting point, and we will need to add more functionality to fully implement the touch command.</p>
<p>Implementing the touch functionality
To implement the touch functionality, we need to first check if the file exists or not. If the file does not exist, we create the file with the specified name. If the file exists, we update the timestamp of the file.</p>
<p>Here’s how we can implement the touch functionality in Rust:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::fs;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Error</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">path</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Path</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">touch</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">: &#x26;</span><span style="color: #E5C07B">str</span><span style="color: #ABB2BF">) -> </span><span style="color: #E5C07B">Result</span><span style="color: #ABB2BF">&#x3C;(), </span><span style="color: #E5C07B">Error</span><span style="color: #ABB2BF">> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Path</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">!</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">exists</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Create the file if it doesn't exist</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">match</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">create</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Ok</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">_</span><span style="color: #ABB2BF">) => {}</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Err</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">) => </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Err</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">),</span></span>
<span class="line"><span style="color: #ABB2BF"> };</span></span>
<span class="line"><span style="color: #ABB2BF"> } </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Update the timestamp of the file if it exists</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">match</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">open</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Ok</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">_</span><span style="color: #ABB2BF">) => {}</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Err</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">) => </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Err</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">),</span></span>
<span class="line"><span style="color: #ABB2BF"> };</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Ok</span><span style="color: #ABB2BF">(())</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>In the above code, we first create a <code>Path</code> object from the given path. Then, we check if the file exists or not using the <code>exists()</code> method. If the file does not exist, we create the file using the <code>create()</code> method. If the file exists, we open the file using the <code>open()</code> method to update its timestamp.</p>
<p>Finally, we return <code>Ok(())</code> if everything runs successfully. Otherwise, we return the error using the <code>Err</code> type.</p>
<p>Outputting the results to the console
The touch command doesn’t usually output any results to the console. Its purpose is to update the modified timestamp of a file or create a new file if it doesn’t exist. However, we can print a message to the console to indicate that the file has been successfully created or updated.</p>
<p>For example, we can print a message like “File <filename> has been updated” or “File <filename> has been created” to indicate that the touch command has completed successfully.</filename></filename></p>
<p>Testing the touch command
To test the touch command, we can create a new file using the touch command and then verify that the file has been created and has the correct modified timestamp.</p>
<p>For example, we can run the following commands:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #E06C75">shell</span><span style="color: #ABB2BF">`$ </span><span style="color: #E06C75">touch</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">new_file</span><span style="color: #ABB2BF">.txt</span></span>
<span class="line"><span style="color: #ABB2BF">$ </span><span style="color: #E06C75">ls</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">l</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">new_file</span><span style="color: #ABB2BF">.txt</span></span></code></pre>
<p>The first command creates a new file called <code>new_file.txt</code> using the touch command. The second command lists the details of the file using the <code>ls</code> command with the <code>-l</code> option, which includes the modified timestamp of the file.</p>
<p>We can verify that the touch command has worked correctly by checking that the <code>new_file.txt</code> file has been created and that its modified timestamp matches the current time. If the file has been created and has the correct modified timestamp, then the touch command has worked correctly.</p>
<h1 id="chapter-8-building-a-locate-command">Chapter 8: Building a Locate Command</h1>
<p>Overview of the locate command and its functionality
The <code>locate</code> command is a utility in Unix-based systems that is used to search for files on the system based on their names. It searches a pre-built database of files and directories on the system, which allows it to quickly find files that match the search criteria.</p>
<p>The <code>locate</code> command is generally faster than using <code>find</code> to search for files because it does not have to search the entire file system each time it is run. However, the database that <code>locate</code> uses needs to be updated periodically to ensure that it includes all new files and directories that have been added to the system since the last update.</p>
<p>By default, the <code>locate</code> command will return a list of all files on the system that match the specified search criteria. It can also be used to search for files that match multiple criteria, such as files that have a specific name and are of a certain file type. The <code>locate</code> command can also be used to restrict the search to specific directories or to exclude certain directories from the search results.</p>
<p>Designing the Rust implementation of the locate command
The <code>locate</code> command is a utility in Unix-based systems that is used to search for files on the system based on their names. It searches a pre-built database of files and directories on the system, which allows it to quickly find files that match the search criteria.</p>
<p>The <code>locate</code> command is generally faster than using <code>find</code> to search for files because it does not have to search the entire file system each time it is run. However, the database that <code>locate</code> uses needs to be updated periodically to ensure that it includes all new files and directories that have been added to the system since the last update.</p>
<p>By default, the <code>locate</code> command will return a list of all files on the system that match the specified search criteria. It can also be used to search for files that match multiple criteria, such as files that have a specific name and are of a certain file type. The <code>locate</code> command can also be used to restrict the search to specific directories or to exclude certain directories from the search results.</p>
<p>Reading and processing the input search query
To begin processing the input search query in a command line Rust application, you can start by retrieving the query from the command line arguments using the <code>std::env::args</code> function. This function returns an iterator over the command line arguments. The first argument is always the name of the program, so you can skip it using the <code>skip</code> method. Then, you can join the remaining arguments into a single string using the <code>collect</code> method.</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::env;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">query</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">env</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">args</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">skip</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">collect</span><span style="color: #ABB2BF">::&#x3C;</span><span style="color: #E5C07B">Vec</span><span style="color: #ABB2BF">&#x3C;</span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">>>().</span><span style="color: #61AFEF">join</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">" "</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"The search query is: {}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">query</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>In this example, we use <code>Vec&#x3C;String></code> to store the command line arguments before joining them into a single string. The <code>::&#x3C;Vec&#x3C;String>></code> syntax is used to specify the type of the <code>collect</code> method’s output, which is a vector of strings. The <code>join</code> method is used to concatenate the vector’s elements into a single string separated by spaces.</p>
<p>Once you have the query string, you can move on to processing it. Does that make sense?</p>
<p>Implementing the locate functionality
Yes, let’s move on to implementing the locate functionality.</p>
<p>To locate files that match the search query, we can use the <code>walkdir</code> crate to traverse the file system and find files. First, we need to add <code>walkdir</code> to our <code>Cargo.toml</code> file:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #E06C75">toml</span><span style="color: #ABB2BF">`[</span><span style="color: #E06C75">dependencies</span><span style="color: #ABB2BF">]</span></span>
<span class="line"><span style="color: #E06C75">walkdir</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"2.3.2"</span></span></code></pre>
<p>Next, we can use <code>walkdir</code> to recursively search for files and check if each file’s name contains the search query:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::env;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">walkdir</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">WalkDir</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">query</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">env</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">args</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">skip</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">collect</span><span style="color: #ABB2BF">::&#x3C;</span><span style="color: #E5C07B">Vec</span><span style="color: #ABB2BF">&#x3C;</span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">>>().</span><span style="color: #61AFEF">join</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">" "</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">files_found</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">WalkDir</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"."</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">into_iter</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">filter_map</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">|</span><span style="color: #E06C75">entry</span><span style="color: #56B6C2">|</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">ok</span><span style="color: #ABB2BF">()) {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">file_type</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">is_file</span><span style="color: #ABB2BF">() </span><span style="color: #56B6C2">&#x26;&#x26;</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">file_name</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">to_string_lossy</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">contains</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">query</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">display</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">files_found</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">files_found</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"No files found."</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>In this example, we use <code>WalkDir::new(".")</code> to create a recursive directory iterator that starts at the current directory. We use the <code>filter_map</code> method to filter out any errors that may occur while walking the directory. We then check if each entry is a file and if its name contains the search query using <code>entry.file_type().is_file()</code> and <code>entry.file_name().to_string_lossy().contains(&#x26;query)</code>, respectively. If a file is found, we print its path using <code>entry.path().display()</code> and increment the <code>files_found</code> counter. Finally, we check if any files were found and print a message if none were found.</p>
<p>Does that help?</p>
<p>Outputting the results to the console
Yes, let’s move on to outputting the results to the console.</p>
<p>We can use Rust’s built-in file I/O functionality to read the contents of each file and print them to the console. To do this, we can open each file using <code>std::fs::File::open</code>, read its contents using <code>std::io::Read::read_to_string</code>, and print the contents using <code>println!</code>.</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::env;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">prelude</span><span style="color: #ABB2BF">::*;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">walkdir</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">WalkDir</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">query</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">env</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">args</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">skip</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">collect</span><span style="color: #ABB2BF">::&#x3C;</span><span style="color: #E5C07B">Vec</span><span style="color: #ABB2BF">&#x3C;</span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">>>().</span><span style="color: #61AFEF">join</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">" "</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">files_found</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">WalkDir</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"."</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">into_iter</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">filter_map</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">|</span><span style="color: #E06C75">entry</span><span style="color: #56B6C2">|</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">ok</span><span style="color: #ABB2BF">()) {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">file_type</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">is_file</span><span style="color: #ABB2BF">() </span><span style="color: #56B6C2">&#x26;&#x26;</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">file_name</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">to_string_lossy</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">contains</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">query</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">match</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">open</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">()) {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Ok</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">) => </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Err</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">_</span><span style="color: #ABB2BF">) => </span><span style="color: #C678DD">continue</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> };</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">contents</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Err</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">_</span><span style="color: #ABB2BF">) </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">read_to_string</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">contents</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">continue</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> };</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}:</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">{}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">display</span><span style="color: #ABB2BF">(), </span><span style="color: #E06C75">contents</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">files_found</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">files_found</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"No files found."</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>In this example, we use <code>File::open</code> to open each file and <code>read_to_string</code> to read its contents into a string. We then print the file’s path and contents using <code>println!</code>. If an error occurs while reading a file, we simply continue to the next file.</p>
<p>Does that make sense?</p>
<p>Testing the locate command
Yes, let’s move on to testing the locate command.</p>
<p>To test the locate command, we can create some test files in a temporary directory and run the command with various search queries. We can use the <code>tempfile</code> crate to create the temporary directory and files:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::env;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">};</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">prelude</span><span style="color: #ABB2BF">::*;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">tempfile</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">TempDir</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">walkdir</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">WalkDir</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">query</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">env</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">args</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">skip</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">collect</span><span style="color: #ABB2BF">::&#x3C;</span><span style="color: #E5C07B">Vec</span><span style="color: #ABB2BF">&#x3C;</span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">>>().</span><span style="color: #61AFEF">join</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">" "</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">files_found</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">temp_dir</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">TempDir</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">expect</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"failed to create temp dir"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file1_path</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">temp_dir</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">join</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"file1.txt"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file1</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">create</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">file1_path</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">expect</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"failed to create file1"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">write!</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file1</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"This is a test file."</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">expect</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"failed to write to file1"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file2_path</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">temp_dir</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">join</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"file2.txt"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file2</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">create</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">file2_path</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">expect</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"failed to create file2"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">write!</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file2</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"This is another test file."</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">expect</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"failed to write to file2"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">WalkDir</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">temp_dir</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">()).</span><span style="color: #61AFEF">into_iter</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">filter_map</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">|</span><span style="color: #E06C75">entry</span><span style="color: #56B6C2">|</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">ok</span><span style="color: #ABB2BF">()) {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">file_type</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">is_file</span><span style="color: #ABB2BF">() </span><span style="color: #56B6C2">&#x26;&#x26;</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">file_name</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">to_string_lossy</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">contains</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">query</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">match</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">open</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">()) {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Ok</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">) => </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Err</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">_</span><span style="color: #ABB2BF">) => </span><span style="color: #C678DD">continue</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> };</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">contents</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Err</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">_</span><span style="color: #ABB2BF">) </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">read_to_string</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">contents</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">continue</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> };</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}:</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">{}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">display</span><span style="color: #ABB2BF">(), </span><span style="color: #E06C75">contents</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">files_found</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">files_found</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"No files found."</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>In this example, we create a temporary directory using <code>TempDir::new</code> and create two test files using <code>File::create</code> and <code>write!</code>. We then use <code>WalkDir</code> to search the temporary directory for files that match the search query.</p>
<p>To test the command, we can run it with different search queries and assert that the output is correct:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #ABB2BF">#[test]</span></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">test_locate</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">output</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">process</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Command</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"target/debug/myapp"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"test"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">output</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">expect</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"failed to run command"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">stdout</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">from_utf8</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">output</span><span style="color: #ABB2BF">.stdout).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">assert_eq!</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">stdout</span><span style="color: #ABB2BF">, </span><span style="color: #61AFEF">format!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}:</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">This is a test file.</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">temp_dir</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">join</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"file1.txt"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">display</span><span style="color: #ABB2BF">()));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">output</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">process</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Command</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"target/debug/myapp"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"another"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">output</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">expect</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"failed to run command"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">stdout</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">from_utf8</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">output</span><span style="color: #ABB2BF">.stdout).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">assert_eq!</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">stdout</span><span style="color: #ABB2BF">, </span><span style="color: #61AFEF">format!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}:</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">This is another test file.</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">temp_dir</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">join</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"file2.txt"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">display</span><span style="color: #ABB2BF">()));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">output</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">process</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Command</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"target/debug/myapp"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"nonexistent"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">output</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">expect</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"failed to run command"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">stdout</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">from_utf8</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">output</span><span style="color: #ABB2BF">.stdout).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">assert_eq!</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">stdout</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"No files found.</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>In this example, we use Rust’s built-in <code>std::process::Command</code> to run the command with different search queries and assert that the output is correct using <code>assert_eq</code>.</p>
<h1 id="chapter-9-building-a-find-command">Chapter 9: Building a Find Command</h1>
<p>Overview of the find command and its functionality
Sure, let me provide an overview of the <code>find</code> command and its functionality.</p>
<p>The <code>find</code> command is a commonly used command-line tool that searches for files in a directory hierarchy based on various criteria such as file name, file type, modification time, etc. It is typically used to locate files that match a specific pattern or criteria.</p>
<p>The <code>find</code> command in Rust can be implemented using the <code>walkdir</code> crate, which provides a convenient way to recursively walk a directory hierarchy and examine the files and directories it contains. Here are some of the key functionalities of the <code>find</code> command:</p>
<ol>
<li>Searching for files by name or extension: The <code>find</code> command can search for files in a directory hierarchy based on their file names or extensions. This can be done using the <code>file_name</code> and <code>extension</code> methods provided by the <code>Path</code> struct.</li>
<li>Searching for files by content: The <code>find</code> command can search for files that contain a specific pattern or text string. This can be done by reading the contents of each file and searching for the pattern using regular expressions or string manipulation functions.</li>
<li>Searching for files by metadata: The <code>find</code> command can also search for files based on their metadata such as modification time, access time, file size, etc. This can be done using the various metadata methods provided by the <code>fs</code> module in Rust.</li>
<li>Recursive searching: The <code>find</code> command can search for files in a directory hierarchy recursively, i.e., it can search for files in all subdirectories of a given directory. This can be done using the <code>walkdir</code> crate, which provides an iterator over all files and directories in a given directory hierarchy.</li>
<li>Outputting results: The <code>find</code> command typically outputs the results of the search to the console, either in a human-readable format or in a machine-readable format that can be processed by other programs.</li>
</ol>
<p>Overall, the <code>find</code> command is a powerful tool for searching for files in a directory hierarchy based on various criteria. In the next section, we will see how to implement the <code>find</code> command in Rust.</p>
<p>Designing the Rust implementation of the find command
Sure, let’s design the Rust implementation of the <code>find</code> command.</p>
<p>We can start by defining the command-line arguments that our <code>find</code> command will support. The basic arguments we will need are the directory to search in, the search pattern, and any options to control the search behavior such as recursive searching, searching by file name or content, etc.</p>
<p>Here is an example of the command-line arguments that our <code>find</code> command could accept:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #D19A66">USAGE</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">find</span><span style="color: #ABB2BF"> [</span><span style="color: #D19A66">FLAGS</span><span style="color: #ABB2BF">] &#x3C;</span><span style="color: #E06C75">directory</span><span style="color: #ABB2BF">> &#x3C;</span><span style="color: #E06C75">pattern</span><span style="color: #ABB2BF">></span></span>
<span class="line"></span>
<span class="line"><span style="color: #D19A66">FLAGS</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">h</span><span style="color: #ABB2BF">, --</span><span style="color: #E06C75">help</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Prints</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">help</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">information</span></span>
<span class="line"><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">r</span><span style="color: #ABB2BF">, --</span><span style="color: #E06C75">recursive</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Recursively</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">search</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">subdirectories</span></span>
<span class="line"><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">n</span><span style="color: #ABB2BF">, --</span><span style="color: #E06C75">name</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Search</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">files</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">by</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">name</span></span>
<span class="line"><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">c</span><span style="color: #ABB2BF">, --</span><span style="color: #E06C75">content</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Search</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">files</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">by</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">content</span></span>
<span class="line"><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">i</span><span style="color: #ABB2BF">, --</span><span style="color: #E06C75">ignore</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">case</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Case</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">insensitive</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">search</span></span>
<span class="line"><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">m</span><span style="color: #ABB2BF">, --</span><span style="color: #E06C75">mtime</span><span style="color: #ABB2BF"> &#x3C;</span><span style="color: #E06C75">days</span><span style="color: #ABB2BF">> </span><span style="color: #E5C07B">Search</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">files</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">modified</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">within</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">the</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">last</span><span style="color: #ABB2BF"> &#x3C;</span><span style="color: #E06C75">days</span><span style="color: #ABB2BF">> </span><span style="color: #E06C75">days</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D19A66">ARGS</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF"> &#x3C;</span><span style="color: #E06C75">directory</span><span style="color: #ABB2BF">> </span><span style="color: #E5C07B">The</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">directory</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">to</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">search</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span></span>
<span class="line"><span style="color: #ABB2BF"> &#x3C;</span><span style="color: #E06C75">pattern</span><span style="color: #ABB2BF">> </span><span style="color: #E5C07B">The</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">search</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">pattern</span></span></code></pre>
<p>Next, we will need to write the Rust code that implements the <code>find</code> command functionality based on the command-line arguments provided. Here are the high-level steps involved in the implementation:</p>
<ol>
<li>Parse the command-line arguments: We can use the <code>clap</code> crate to parse the command-line arguments and extract the relevant options and arguments.</li>
<li>Perform the search: Based on the options provided, we will need to search for files in the specified directory that match the search pattern. We can use the <code>walkdir</code> crate to recursively search the directory hierarchy and filter the files based on the search criteria.</li>
<li>Output the results: Once the search is complete, we need to output the results to the console in a human-readable format. We can use the <code>println!</code> macro or the <code>prettytable</code> crate to format the results as a table or list.</li>
</ol>
<p>Here’s some Rust code that demonstrates how to implement the <code>find</code> command using the steps outlined above:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">crate</span><span style="color: #ABB2BF"> clap;</span></span>
<span class="line"><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">crate</span><span style="color: #ABB2BF"> walkdir;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">clap</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">App</span><span style="color: #ABB2BF">};</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">path</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">PathBuf</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">walkdir</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">DirEntry</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">WalkDir</span><span style="color: #ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">App</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"find"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">version</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"1.0"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">author</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Your Name"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">about</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Search for files in a directory hierarchy"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"directory"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"The directory to search in"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">required</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">index</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"pattern"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"The search pattern"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">required</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">index</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"recursive"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">short</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"r"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">long</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"recursive"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Recursively search subdirectories"</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"name"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">short</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"n"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">long</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"name"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Search files by name"</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"content"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">short</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"c"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">long</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"content"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Search files by content"</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"ignore-case"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">short</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"i"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">long</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"ignore-case"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Case-insensitive search"</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"mtime"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">short</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"m"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">long</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"mtime"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">value_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"days"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Search files modified within the last &#x3C;days> days"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">takes_value</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">get_matches</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">directory</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">PathBuf</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">from</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">value_of</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"directory"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">pattern</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">value_of</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"pattern"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">recursive</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_present</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"recursive"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">search_by_name</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_present</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"name"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">search_by_content</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_present</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"content"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">ignore_case</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_present</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"ignore-case"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">mtime_days</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">value_of</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"mtime"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">map</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">|</span><span style="color: #E06C75">d</span><span style="color: #56B6C2">|</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">d</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">parse</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">());</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">search_result</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">search_files</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">directory</span><span style="color: #ABB2BF">, &#x26;</span><span style="color: #E06C75">pattern</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">recursive</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">search_by_name</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">search_by_content</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">ignore_case</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">mtime_days</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// Print the search results</span></span>
<span class="line"><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file_path</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">search_result</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">file_path</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">display</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">search_files</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">directory</span><span style="color: #ABB2BF">: &#x26;</span><span style="color: #E5C07B">Path</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">pattern</span><span style="color: #ABB2BF">: &#x26;</span><span style="color: #E5C07B">str</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">recursive</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">bool</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">search_by_name</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">bool</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">search_by_content</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">bool</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">ignore_case</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">bool</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">mtime_days</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">Option</span><span style="color: #ABB2BF">&#x3C;</span><span style="color: #E5C07B">u64</span><span style="color: #ABB2BF">>,</span></span>
<span class="line"><span style="color: #ABB2BF">    ) -> </span><span style="color: #E5C07B">Vec</span><span style="color: #ABB2BF">&#x3C;</span><span style="color: #E5C07B">PathBuf</span><span style="color: #ABB2BF">> {</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">result</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Vec</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">walker</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">WalkDir</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">directory</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">recursive</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">walker</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">walker</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">into_iter</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">    } </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">walker</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">walker</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">max_depth</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">into_iter</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">walker</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">filter_entry</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">|</span><span style="color: #E06C75">e</span><span style="color: #56B6C2">|</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">!</span><span style="color: #61AFEF">is_hidden</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">)).</span><span style="color: #61AFEF">filter_map</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">|</span><span style="color: #E06C75">e</span><span style="color: #56B6C2">|</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">ok</span><span style="color: #ABB2BF">()) {</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file_name</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">file_name</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">to_string_lossy</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">into_owned</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">        // Search by name</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">search_by_name</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">pattern_match</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">ignore_case</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #E06C75">file_name</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">to_lowercase</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">contains</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">pattern</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">to_lowercase</span><span style="color: #ABB2BF">())</span></span>
<span class="line"><span style="color: #ABB2BF">            } </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #E06C75">file_name</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">contains</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">pattern</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">            };</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">pattern_match</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #E06C75">result</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">to_path_buf</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #ABB2BF">            }</span></span>
<span class="line"><span style="color: #ABB2BF">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">        // Search by content</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">search_by_content</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file_contents</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">read_to_string</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">()).</span><span style="color: #61AFEF">unwrap_or_default</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">pattern_match</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">ignore_case</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #E06C75">file_contents</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">to_lowercase</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">contains</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">pattern</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">to_lowercase</span><span style="color: #ABB2BF">())</span></span>
<span class="line"><span style="color: #ABB2BF">            } </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #E06C75">file_contents</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">contains</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">pattern</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">            };</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">pattern_match</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #E06C75">result</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">to_path_buf</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #ABB2BF">            }</span></span>
<span class="line"><span style="color: #ABB2BF">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">        // Search by modified time</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Some</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">mtime_days</span><span style="color: #ABB2BF">) </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">mtime_days</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">duration</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">time</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">SystemTime</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">now</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">duration_since</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">metadata</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">modified</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">()).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">days</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">duration</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">as_secs</span><span style="color: #ABB2BF">() / </span><span style="color: #D19A66">86400</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">days</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">&#x3C;=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">mtime_days</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #E06C75">result</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">to_path_buf</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #ABB2BF">            }</span></span>
<span class="line"><span style="color: #ABB2BF">        }</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">result</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">is_hidden</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">: &#x26;</span><span style="color: #E5C07B">DirEntry</span><span style="color: #ABB2BF">) -> </span><span style="color: #E5C07B">bool</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">file_name</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF">    .</span><span style="color: #61AFEF">to_str</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF">    .</span><span style="color: #61AFEF">map</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">|</span><span style="color: #E06C75">s</span><span style="color: #56B6C2">|</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">s</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">starts_with</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"."</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF">    .</span><span style="color: #61AFEF">unwrap_or</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">false</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>The <code>search_files</code> function implements the file search logic based on the command-line arguments. It uses the <code>WalkDir</code> crate to recursively search the directory hierarchy and filter the files based on the specified search criteria. The search function returns a vector of <code>PathBuf</code> objects representing the paths of the matching files.</p>
<p>Finally, the <code>main</code> function parses the command-line arguments using the <code>clap</code> crate, calls the <code>search_files</code> function to perform the search, and prints the search results to the console using the <code>println!</code> macro.</p>
<p>This implementation should provide a basic <code>find</code> command functionality in Rust that can be extended to support additional search options as needed.</p>
<p>Reading and processing the input directory and search query
Sure, let’s implement the functionality to read and process the input directory and search query. Here’s the updated code:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">path</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">PathBuf</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">structopt</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">StructOpt</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">#[derive(</span><span style="color: #E5C07B">StructOpt</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #C678DD">struct</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Cli</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> #[structopt(parse(from_os_str))]</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">directory</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">PathBuf</span><span style="color: #ABB2BF">,</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> #[structopt()]</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">query</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">args</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Cli</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">from_args</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">directory</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">args</span><span style="color: #ABB2BF">.directory;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">query</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">args</span><span style="color: #ABB2BF">.query;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Print the input values for verification</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Searching for '{}' in directory '{}'"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">query</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">directory</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">display</span><span style="color: #ABB2BF">());</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // TODO: Implement the file search logic</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>We added a new <code>directory</code> field to the <code>Cli</code> struct to represent the input directory, and modified the <code>query</code> field to be of type <code>String</code> instead of <code>Vec&#x3C;String></code> since we’re only searching for a single query.</p>
<p>In the <code>main</code> function, we parse the command-line arguments using the <code>StructOpt</code> crate, extract the <code>directory</code> and <code>query</code> values from the parsed arguments, and print them to the console for verification.</p>
<p>Next, we need to implement the file search logic to search for the query in the specified directory.</p>
<p>Implementing the find functionality
Great, let’s implement the file search logic to search for the query in the specified directory. Here’s the updated code:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">DirEntry</span><span style="color: #ABB2BF">};</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::io;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">path</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">Path</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">PathBuf</span><span style="color: #ABB2BF">};</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">structopt</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">StructOpt</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">#[derive(</span><span style="color: #E5C07B">StructOpt</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #C678DD">struct</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Cli</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> #[structopt(parse(from_os_str))]</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">directory</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">PathBuf</span><span style="color: #ABB2BF">,</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> #[structopt()]</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">query</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">search_dir</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">dir</span><span style="color: #ABB2BF">: &#x26;</span><span style="color: #E5C07B">Path</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">query</span><span style="color: #ABB2BF">: &#x26;</span><span style="color: #E5C07B">str</span><span style="color: #ABB2BF">) -> </span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Result</span><span style="color: #ABB2BF">&#x3C;()> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">read_dir</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">dir</span><span style="color: #ABB2BF">)? {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">?;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_dir</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">search_dir</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">query</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF"> } </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">filename</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">file_name</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">to_string_lossy</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">filename</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">contains</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">query</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">display</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Ok</span><span style="color: #ABB2BF">(())</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() -> </span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Result</span><span style="color: #ABB2BF">&#x3C;()> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">args</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Cli</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">from_args</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">directory</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">args</span><span style="color: #ABB2BF">.directory;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">query</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">args</span><span style="color: #ABB2BF">.query;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Print the input values for verification</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Searching for '{}' in directory '{}'"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">query</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">directory</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">display</span><span style="color: #ABB2BF">());</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">search_dir</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">directory</span><span style="color: #ABB2BF">, &#x26;</span><span style="color: #E06C75">query</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Ok</span><span style="color: #ABB2BF">(())</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>We added a new <code>search_dir</code> function that takes in a directory path and query string as arguments, and searches for files in the directory and its subdirectories that contain the query in their filenames.</p>
<p>In the <code>main</code> function, we first print the input values for verification, then call the <code>search_dir</code> function with the specified directory and query.</p>
<p>The <code>search_dir</code> function uses the <code>fs::read_dir</code> function to read the contents of the directory and returns an iterator over the <code>DirEntry</code> objects of each file or directory in the directory. For each entry, we check if it is a directory and if so, recursively call the <code>search_dir</code> function with the directory path. If it is a file, we extract the filename from the <code>DirEntry</code> object and check if it contains the query using the <code>contains</code> method of the <code>String</code> type. If it does, we print the file path to the console.</p>
<p>Finally, we wrap the <code>main</code> function in an <code>io::Result</code> to handle any errors that may occur during file I/O operations.</p>
<p>Outputting the results to the console
We have already implemented the functionality to output the results to the console while searching for the files that match the query. In the <code>search_dir</code> function, we print the file path to the console if it matches the query using the <code>println!</code> macro. Here’s the relevant code:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">filename</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">contains</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">query</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">display</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>This will output the path of each file that matches the query to the console.</p>
<p>Testing the find command
Sure, let’s test the <code>find</code> command with some sample data.</p>
<p>Assume that we have a directory named <code>test</code> with the following contents:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #E06C75">test</span><span style="color: #ABB2BF">/</span></span>
<span class="line"><span style="color: #ABB2BF">├── </span><span style="color: #E06C75">animals</span></span>
<span class="line"><span style="color: #ABB2BF">│   ├── </span><span style="color: #E06C75">dog</span><span style="color: #ABB2BF">.txt</span></span>
<span class="line"><span style="color: #ABB2BF">│   ├── </span><span style="color: #E06C75">cat</span><span style="color: #ABB2BF">.txt</span></span>
<span class="line"><span style="color: #ABB2BF">│   ├── </span><span style="color: #E06C75">lion</span><span style="color: #ABB2BF">.txt</span></span>
<span class="line"><span style="color: #ABB2BF">│   └── </span><span style="color: #E06C75">bear</span><span style="color: #ABB2BF">.png</span></span>
<span class="line"><span style="color: #ABB2BF">├── </span><span style="color: #E06C75">fruits</span></span>
<span class="line"><span style="color: #ABB2BF">│   ├── </span><span style="color: #E06C75">apple</span><span style="color: #ABB2BF">.png</span></span>
<span class="line"><span style="color: #ABB2BF">│   ├── </span><span style="color: #E06C75">banana</span><span style="color: #ABB2BF">.png</span></span>
<span class="line"><span style="color: #ABB2BF">│   └── </span><span style="color: #E06C75">orange</span><span style="color: #ABB2BF">.png</span></span>
<span class="line"><span style="color: #ABB2BF">├── </span><span style="color: #E06C75">vegetables</span></span>
<span class="line"><span style="color: #ABB2BF">│   ├── </span><span style="color: #E06C75">carrot</span><span style="color: #ABB2BF">.txt</span></span>
<span class="line"><span style="color: #ABB2BF">│   ├── </span><span style="color: #E06C75">potato</span><span style="color: #ABB2BF">.txt</span></span>
<span class="line"><span style="color: #ABB2BF">│   └── </span><span style="color: #E06C75">tomato</span><span style="color: #ABB2BF">.png</span></span>
<span class="line"><span style="color: #ABB2BF">└── </span><span style="color: #E06C75">numbers</span><span style="color: #ABB2BF">.txt</span></span></code></pre>
<p>We want to search for all files that contain the string “at” in the <code>test</code> directory. To do so, we can run the following command in the terminal:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #E06C75">shell</span><span style="color: #ABB2BF">`$ </span><span style="color: #E06C75">find</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">test</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">at</span></span></code></pre>
<p>This will output the following results:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #E5C07B">Searching</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">'at'</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">directory</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">'test'</span></span>
<span class="line"><span style="color: #E06C75">test</span><span style="color: #ABB2BF">/</span><span style="color: #E06C75">animals</span><span style="color: #ABB2BF">/</span><span style="color: #E06C75">cat</span><span style="color: #ABB2BF">.txt</span></span>
<span class="line"><span style="color: #E06C75">test</span><span style="color: #ABB2BF">/</span><span style="color: #E06C75">animals</span><span style="color: #ABB2BF">/</span><span style="color: #E06C75">lion</span><span style="color: #ABB2BF">.txt</span></span>
<span class="line"><span style="color: #E06C75">test</span><span style="color: #ABB2BF">/</span><span style="color: #E06C75">fruits</span><span style="color: #ABB2BF">/</span><span style="color: #E06C75">apple</span><span style="color: #ABB2BF">.png</span></span>
<span class="line"><span style="color: #E06C75">test</span><span style="color: #ABB2BF">/</span><span style="color: #E06C75">fruits</span><span style="color: #ABB2BF">/</span><span style="color: #E06C75">banana</span><span style="color: #ABB2BF">.png</span></span>
<span class="line"><span style="color: #E06C75">test</span><span style="color: #ABB2BF">/</span><span style="color: #E06C75">fruits</span><span style="color: #ABB2BF">/</span><span style="color: #E06C75">orange</span><span style="color: #ABB2BF">.png</span></span>
<span class="line"><span style="color: #E06C75">test</span><span style="color: #ABB2BF">/</span><span style="color: #E06C75">vegetables</span><span style="color: #ABB2BF">/</span><span style="color: #E06C75">carrot</span><span style="color: #ABB2BF">.txt</span></span>
<span class="line"><span style="color: #E06C75">test</span><span style="color: #ABB2BF">/</span><span style="color: #E06C75">vegetables</span><span style="color: #ABB2BF">/</span><span style="color: #E06C75">potato</span><span style="color: #ABB2BF">.txt</span></span></code></pre>
<p>This indicates that all files containing the string “at” in their filename have been found in the <code>test</code> directory and its subdirectories.</p>
<h1 id="chapter-10-building-a-grep-command">Chapter 10: Building a Grep Command</h1>
<p>Overview of the grep command and its functionality
The <code>grep</code> command is a popular Unix command-line utility used for searching text files for lines that match a given regular expression pattern. The name “grep” is short for “global regular expression print”. The command takes one or more files as input and outputs any lines that match the specified pattern to the console.</p>
<p>The basic syntax of the <code>grep</code> command is as follows:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #E06C75">grep</span><span style="color: #ABB2BF"> [</span><span style="color: #E06C75">options</span><span style="color: #ABB2BF">] </span><span style="color: #E06C75">pattern</span><span style="color: #ABB2BF"> [</span><span style="color: #E06C75">file</span><span style="color: #ABB2BF"> ...]</span></span></code></pre>
<p>Here, <code>pattern</code> is a regular expression pattern that specifies the search pattern, and <code>file</code> is one or more input files to search.</p>
<p>The <code>grep</code> command has a wide range of options that allow you to customize its behavior. For example, you can use the <code>-i</code> option to perform a case-insensitive search, or the <code>-n</code> option to output the line number for each match.</p>
<p>The <code>grep</code> command is a powerful tool for searching through large text files and can be used in a variety of scenarios, such as searching log files for errors or finding specific configuration settings in a configuration file.</p>
<p>Designing the Rust implementation of the grep command
To implement the <code>grep</code> command in Rust, we can follow the following steps:</p>
<ol>
<li>Parse the command-line arguments to extract the search pattern and input file(s) to search.</li>
<li>Open each input file and search for lines that match the search pattern.</li>
<li>For each line that matches, output the line to the console.</li>
</ol>
<p>Let’s go through each of these steps in more detail.</p>
<h3 id="parsing-command-line-arguments">Parsing Command-Line Arguments</h3>
<p>To parse the command-line arguments, we can use the <code>clap</code> crate, which provides a convenient way to define and parse command-line arguments. We will define two positional arguments: the search pattern and the input file(s) to search. We will also define an optional <code>-i</code> flag to enable case-insensitive search.</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">clap</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">App</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">App</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"grep"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"pattern"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"The pattern to search for"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">required</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">index</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">),</span></span>
<span class="line"><span style="color: #ABB2BF"> )</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"input"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"The input file to search"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">required</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">index</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">),</span></span>
<span class="line"><span style="color: #ABB2BF"> )</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"ignore-case"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">short</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"i"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">long</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"ignore-case"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Perform a case-insensitive search"</span><span style="color: #ABB2BF">),</span></span>
<span class="line"><span style="color: #ABB2BF"> )</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">get_matches</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">pattern</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">value_of</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"pattern"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">input</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">value_of</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"input"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">ignore_case</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_present</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"ignore-case"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // ...</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>This code defines a command-line application called <code>grep</code> with two required positional arguments: <code>pattern</code> and <code>input</code>. It also defines an optional <code>ignore-case</code> flag. The <code>clap</code> crate automatically generates a help message for the application based on the argument definitions.</p>
<h3 id="searching-for-lines-that-match-the-search-pattern">Searching for Lines That Match the Search Pattern</h3>
<p>To search for lines that match the search pattern, we can open the input file and read it line by line. For each line, we can check if it matches the search pattern using a regular expression. We can use the <code>regex</code> crate to define and match regular expressions.</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">regex</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Regex</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">BufRead</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">BufReader</span><span style="color: #ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // ...</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">open</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">input</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">reader</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">BufReader</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">re</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">ignore_case</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Regex</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #61AFEF">format!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"(?i){}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">pattern</span><span style="color: #ABB2BF">)).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF"> } </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Regex</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">pattern</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF"> };</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">i</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">reader</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">lines</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">enumerate</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">re</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_match</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">line</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}: {}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">i</span><span style="color: #ABB2BF"> + </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>This code opens the input file and creates a buffered reader to read it line by line. It then defines a regular expression based on the search pattern and iterates over each line, checking if it matches the regular expression. If a match is found, it prints the line number and the matching line to the console.</p>
<h3 id="putting-it-all-together">Putting It All Together</h3>
<p>Putting all the code together, our implementation of the <code>grep</code> command in Rust looks like this:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">BufRead</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">BufReader</span><span style="color: #ABB2BF">};</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">regex</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Regex</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Parse command-line arguments using `clap</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">clap</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">App</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"grep"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">version</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"1.0"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">author</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Your Name"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">about</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"A command-line utility to search for a pattern in a file"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">clap</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"pattern"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"The pattern to search for"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">required</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">),</span></span>
<span class="line"><span style="color: #ABB2BF"> )</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">clap</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"input"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"The input file to search in"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">required</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">),</span></span>
<span class="line"><span style="color: #ABB2BF"> )</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">clap</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"ignore-case"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">short</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"i"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">long</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"ignore-case"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Perform a case-insensitive search"</span><span style="color: #ABB2BF">),</span></span>
<span class="line"><span style="color: #ABB2BF"> )</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">get_matches</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Extract command-line arguments</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">pattern</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">value_of</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"pattern"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">input_file</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">value_of</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"input"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">ignore_case</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_present</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"ignore-case"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Create regular expression based on pattern</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">regex</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">ignore_case</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Regex</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #61AFEF">format!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"(?i){}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">pattern</span><span style="color: #ABB2BF">)).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF"> } </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Regex</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">pattern</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF"> };</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Open input file and create buffered reader</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">open</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">input_file</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">reader</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">BufReader</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Process each line of input</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">line_number</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">reader</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">lines</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">enumerate</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">regex</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_match</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">line</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}: {}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">line_number</span><span style="color: #ABB2BF"> + </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>This code creates a regular expression based on the search query, and uses the <code>is_match</code> method to check if each line of the file matches the pattern. If a match is found, it prints the line number and the matching line to the console.</p>
<h3 id="error-handling">Error Handling</h3>
<p>We should also improve error handling by using the <code>Result</code> type to handle potential errors. Here’s the updated code with improved error handling:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">BufRead</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">BufReader</span><span style="color: #ABB2BF">};</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">regex</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Regex</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() -> </span><span style="color: #E5C07B">Result</span><span style="color: #ABB2BF">&#x3C;(), </span><span style="color: #E5C07B">Box</span><span style="color: #ABB2BF">&#x3C;</span><span style="color: #C678DD">dyn</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">std</span><span style="color: #ABB2BF">::</span><span style="color: #E06C75">error</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Error</span><span style="color: #ABB2BF">>> {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // Parse command-line arguments using `clap`</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">clap</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">App</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"grep"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">        .</span><span style="color: #61AFEF">version</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"1.0"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">        .</span><span style="color: #61AFEF">author</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Your Name"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">        .</span><span style="color: #61AFEF">about</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"A command-line utility to search for a pattern in a file"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">        .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #E5C07B">clap</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"pattern"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">                .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"The pattern to search for"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">                .</span><span style="color: #61AFEF">required</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">),</span></span>
<span class="line"><span style="color: #ABB2BF">        )</span></span>
<span class="line"><span style="color: #ABB2BF">        .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #E5C07B">clap</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"input"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">                .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"The input file to search in"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">                .</span><span style="color: #61AFEF">required</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">),</span></span>
<span class="line"><span style="color: #ABB2BF">        )</span></span>
<span class="line"><span style="color: #ABB2BF">        .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #E5C07B">clap</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"ignore-case"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">                .</span><span style="color: #61AFEF">short</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"i"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">                .</span><span style="color: #61AFEF">long</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"ignore-case"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">                .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Perform a case-insensitive search"</span><span style="color: #ABB2BF">),</span></span>
<span class="line"><span style="color: #ABB2BF">        )</span></span>
<span class="line"><span style="color: #ABB2BF">        .</span><span style="color: #61AFEF">get_matches</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // Extract command-line arguments</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">pattern</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">value_of</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"pattern"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">input_file</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">value_of</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"input"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">ignore_case</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_present</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"ignore-case"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // Create a regex pattern to search for</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">re</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">ignore_case</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">Regex</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #61AFEF">format!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"(?i){}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">pattern</span><span style="color: #ABB2BF">))?</span></span>
<span class="line"><span style="color: #ABB2BF">    } </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">Regex</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">pattern</span><span style="color: #ABB2BF">)?</span></span>
<span class="line"><span style="color: #ABB2BF">    };</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // Open the input file</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">open</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">input_file</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">reader</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">BufReader</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // Iterate over each line and print matching lines</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">reader</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">lines</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF">?;</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">re</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_match</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">line</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">        }</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">Ok</span><span style="color: #ABB2BF">(())</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>This implementation of grep in Rust uses the clap library to parse command-line arguments. The program takes two required arguments: the pattern to search for and the input file to search in. It also provides an optional flag to perform a case-insensitive search.</p>
<p>The program first extracts the command-line arguments and creates a regex pattern to search for based on the input pattern and whether the case-insensitive flag is set. It then opens the input file and iterates over each line, printing out any lines that match the regex pattern.</p>
<p>Outputting the results to the console
In the <code>grep</code> command, we output the results to the console using the <code>println!</code> macro. We print the line number and the line contents for each line that contains the search <code>pattern</code>.</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">line_contents</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">contains</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">pattern</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}: {}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">line_number</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">line_contents</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>The output format is <code>&#x3C;line_number>: &#x3C;line_contents></code> for each matching line.</p>
<p>We could also format the output differently based on user preferences, such as printing only the line contents without the line number, or printing the line number in a different format. We can achieve this by adding additional command-line arguments to specify the output format.</p>
<p>Testing the grep command
To test the <code>grep</code> command, we can create a test file with some lines that contain the search pattern and some that do not.</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #E06C75">echo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"this is a test file"</span><span style="color: #ABB2BF"> > </span><span style="color: #E06C75">test</span><span style="color: #ABB2BF">.txt</span></span>
<span class="line"><span style="color: #E06C75">echo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"with some matching and non-matching lines"</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">>></span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">test</span><span style="color: #ABB2BF">.txt</span></span>
<span class="line"><span style="color: #E06C75">echo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"for testing the grep command"</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">>></span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">test</span><span style="color: #ABB2BF">.txt</span></span>
<span class="line"><span style="color: #E06C75">echo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"grep command is used to search for a pattern in a file"</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">>></span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">test</span><span style="color: #ABB2BF">.txt</span></span>
<span class="line"><span style="color: #E06C75">echo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"the matching lines should be printed with line numbers"</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">>></span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">test</span><span style="color: #ABB2BF">.txt</span></span></code></pre>
<p>Now, we can run the <code>grep</code> command with a search pattern and the test file as the input file.</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #ABB2BF">$ ./</span><span style="color: #E06C75">grep</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"test"</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">test</span><span style="color: #ABB2BF">.txt</span></span>
<span class="line"><span style="color: #D19A66">1</span><span style="color: #ABB2BF">: </span><span style="color: #E06C75">this</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">is</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">a</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">test</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span></span>
<span class="line"><span style="color: #D19A66">2</span><span style="color: #ABB2BF">: </span><span style="color: #E06C75">with</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">some</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matching</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">and</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">non</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">matching</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">lines</span></span>
<span class="line"><span style="color: #D19A66">4</span><span style="color: #ABB2BF">: </span><span style="color: #E06C75">grep</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">command</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">is</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">used</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">to</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">search</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">a</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">pattern</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">a</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span></span>
<span class="line"><span style="color: #D19A66">5</span><span style="color: #ABB2BF">: </span><span style="color: #E06C75">the</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matching</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">lines</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">should</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">be</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">printed</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">with</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">numbers</span></span></code></pre>
<p>The <code>grep</code> command should output the lines that contain the search pattern along with their line numbers. In this case, the lines that contain the word “test” are on lines 1, 2, 4, and 5.</p>
<p>We can also test the <code>grep</code> command with different search patterns and input files to ensure that it works correctly in all cases.</p>
<h1 id="chapter-11-building-a-tar-command">Chapter 11: Building a Tar Command</h1>
<p>Overview of the tar command and its functionality
The <code>tar</code> command is used to create and manipulate archives in the TAR format. TAR stands for Tape Archive and it was originally used for storing files on magnetic tape. The TAR format allows multiple files to be stored in a single archive file.</p>
<p>The <code>tar</code> command can be used to create new archive files, extract files from existing archives, add files to existing archives, and list the contents of archives.</p>
<p>The <code>tar</code> command can also be used to compress archives using compression algorithms such as gzip, bzip2, and xz. The compressed archives are typically named with extensions such as <code>.tar.gz</code>, <code>.tar.bz2</code>, and <code>.tar.xz</code>.</p>
<p>The <code>tar</code> command provides many options and command-line arguments for controlling the behavior of the command, including options for setting file permissions, preserving file timestamps, and handling symbolic links.</p>
<p>Designing the Rust implementation of the tar command
The Rust implementation of the <code>tar</code> command can be designed with the following components:</p>
<ol>
<li>Parsing command-line arguments: The <code>tar</code> command can take multiple arguments such as the archive file name, files to be added to the archive, files to be extracted from the archive, and compression options. These arguments can be parsed using a Rust command-line argument parser such as <code>clap</code>.</li>
<li>Creating new archives: If the <code>tar</code> command is invoked with the option to create a new archive, we need to create a new TAR archive file and add the specified files to the archive. We can use the <code>tar-rs</code> crate to create the TAR archive file and add the files to the archive.</li>
<li>Extracting files from archives: If the <code>tar</code> command is invoked with the option to extract files from an existing archive, we need to read the contents of the TAR archive file and extract the specified files to the current directory. We can use the <code>tar-rs</code> crate to read the TAR archive file and extract the specified files.</li>
<li>Adding files to existing archives: If the <code>tar</code> command is invoked with the option to add files to an existing archive, we need to read the contents of the TAR archive file, add the specified files to the archive, and write the updated archive file. We can use the <code>tar-rs</code> crate to read the TAR archive file, add the specified files to the archive, and write the updated archive file.</li>
<li>Compressing archives: If the <code>tar</code> command is invoked with compression options such as gzip, bzip2, or xz, we need to compress the TAR archive file using the specified compression algorithm. We can use Rust compression libraries such as <code>flate2</code> for gzip compression and <code>xz2</code> for xz compression.</li>
<li>Listing archive contents: If the <code>tar</code> command is invoked with the option to list the contents of an existing archive, we need to read the contents of the TAR archive file and print the list of files in the archive. We can use the <code>tar-rs</code> crate to read the TAR archive file and print the list of files.</li>
<li>Handling errors: We need to handle errors gracefully by displaying error messages to the user and exiting the command with an appropriate exit code.</li>
</ol>
<p>Reading and processing the input files or directories
To implement the <code>tar</code> command in Rust, we need to read and process the input files or directories based on the command-line arguments.</p>
<p>If the <code>tar</code> command is invoked with the option to create a new archive, we need to read the input files and add them to the new archive. If the <code>tar</code> command is invoked with the option to extract files from an existing archive, we need to read the archive file and extract the specified files to the current directory. If the <code>tar</code> command is invoked with the option to add files to an existing archive, we need to read the archive file, add the input files to the archive, and write the updated archive file.</p>
<p>We can use Rust’s standard library to read and process the input files and directories. To read a file, we can use the <code>File</code> struct and <code>BufReader</code> struct to read the contents of the file. To read a directory, we can use the <code>read_dir</code> function from the <code>std::fs</code> module to get a <code>DirEntry</code> iterator for the directory. We can then iterate over the entries in the directory and read the files using the <code>File</code> and <code>BufReader</code> structs.</p>
<p>Once we have read the input files or directories, we can add them to the new archive or extract them from the existing archive using the <code>tar-rs</code> crate. If the <code>tar</code> command is invoked with compression options, we can compress the archive using Rust compression libraries such as <code>flate2</code> or <code>xz2</code>.</p>
<p>In summary, reading and processing the input files or directories in Rust involves using the standard library to read files and directories, and using the <code>tar-rs</code> crate to create, extract, or update TAR archives.</p>
<p>Implementing the tar functionality
To implement the <code>tar</code> command in Rust, we first need to read the command-line arguments and determine what action to take. We can use the <code>clap</code> crate to parse the command-line arguments.</p>
<p>Here’s an example code snippet to read the command-line arguments and determine what action to take:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">clap</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">App</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">App</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"tar"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">version</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"1.0"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">author</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Your Name"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">about</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"A TAR archiver"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"create"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">short</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"c"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">long</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"create"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">value_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"FILE"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Create a new archive"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">takes_value</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">),</span></span>
<span class="line"><span style="color: #ABB2BF"> )</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"extract"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">short</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"x"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">long</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"extract"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">value_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"FILE"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Extract files from an archive"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">takes_value</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">),</span></span>
<span class="line"><span style="color: #ABB2BF"> )</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"add"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">short</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"a"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">long</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"add"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">value_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"FILE"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Add files to an archive"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">takes_value</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">),</span></span>
<span class="line"><span style="color: #ABB2BF"> )</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"gzip"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">short</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"z"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">long</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"gzip"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Compress the archive with gzip"</span><span style="color: #ABB2BF">),</span></span>
<span class="line"><span style="color: #ABB2BF"> )</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"xz"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">short</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"J"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">long</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"xz"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Compress the archive with xz"</span><span style="color: #ABB2BF">),</span></span>
<span class="line"><span style="color: #ABB2BF"> )</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">get_matches</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_present</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"create"</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Create a new archive</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">filename</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">value_of</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"create"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Read the input files and add them to the archive</span></span>
<span class="line"><span style="color: #ABB2BF">} </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_present</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"extract"</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Extract files from an archive</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">filename</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">value_of</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"extract"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Extract the specified files from the archive</span></span>
<span class="line"><span style="color: #ABB2BF">} </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_present</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"add"</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Add files to an archive</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">filename</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">value_of</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"add"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Read the input files and add them to the archive</span></span>
<span class="line"><span style="color: #ABB2BF">} </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Show help and exit</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">usage</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">process</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">exit</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>Next, we need to implement the logic for each action. Here’s an example implementation for creating a new archive:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">prelude</span><span style="color: #ABB2BF">::*;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">path</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Path</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">tar</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">Builder</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">Header</span><span style="color: #ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// Get the output filename from the command-line arguments</span></span>
<span class="line"><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">filename</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">value_of</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"create"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// Create a new archive file</span></span>
<span class="line"><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_present</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"gzip"</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">create</span><span style="color: #ABB2BF">(</span><span style="color: #61AFEF">format!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}.gz"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">filename</span><span style="color: #ABB2BF">)).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF">} </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_present</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"xz"</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">create</span><span style="color: #ABB2BF">(</span><span style="color: #61AFEF">format!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"{}.xz"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">filename</span><span style="color: #ABB2BF">)).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF">} </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">create</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">filename</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// Create a TAR builder for the archive file</span></span>
<span class="line"><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">builder</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Builder</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// Read the input files and add them to the archive</span></span>
<span class="line"><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file_name</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">values_of</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"file"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Path</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file_name</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">open</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Create a TAR header for the file</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">header</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Header</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new_gnu</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">header</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">set_path</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">header</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">set_size</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">metadata</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">len</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">header</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">set_mode</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0o644</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">builder</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">append</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">header</span><span style="color: #ABB2BF">, &#x26;</span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>Similarly, we can implement the logic for extracting files.</p>
<p>We will create a new file using File::create() method and a new BufWriter. Then, we will loop through each file and add them to the archive using the add_file() method of the Builder.</p>
<p>Here is the implementation:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">, metadata};</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">BufWriter</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">Write</span><span style="color: #ABB2BF">};</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">path</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Path</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">tar</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">Builder</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">Header</span><span style="color: #ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">create_archive</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">archive_path</span><span style="color: #ABB2BF">: &#x26;</span><span style="color: #E5C07B">Path</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">files</span><span style="color: #ABB2BF">: &#x26;[</span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">]) -> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Result</span><span style="color: #ABB2BF">&#x3C;()> {</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">create</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">archive_path</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">writer</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">BufWriter</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">builder</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Builder</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">writer</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file_path</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">files</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Path</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file_path</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">meta</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">metadata</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">header</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Header</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new_gnu</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">header</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">set_path</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">header</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">set_size</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">meta</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">len</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">header</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">set_mode</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">meta</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">mode</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">header</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">set_cksum</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">open</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">builder</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">append</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">header</span><span style="color: #ABB2BF">, &#x26;</span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">Ok</span><span style="color: #ABB2BF">(())</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>In this implementation, we first create a new file at the specified archive_path using the File::create() method. We then create a new BufWriter to buffer the output of the file. We use this BufWriter to create a new Builder instance.</p>
<p>We then loop through each file in the files slice and add them to the archive. We create a new Path instance from the file path, and use the metadata() method to get information about the file, such as its size and mode. We use this information to create a new Header instance, which we configure with the appropriate metadata. Finally, we open the file and pass it to the Builder instance’s append() method, along with the Header instance.</p>
<p>This implementation should successfully create a tar archive from the specified files.</p>
<p>Outputting the results to the console or archive file
To output the results of the <code>tar</code> command to the console or archive file, we can modify the <code>create_archive()</code> function to take an additional argument specifying the output location. If the output location is <code>None</code>, we simply output the tar archive to the console. If it is a <code>Some</code> value, we create the archive at the specified path.</p>
<p>Here’s the updated implementation:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">, metadata};</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">BufWriter</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">Write</span><span style="color: #ABB2BF">};</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">path</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Path</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">tar</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">Builder</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">Header</span><span style="color: #ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">create_archive</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">archive_path</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">Option</span><span style="color: #ABB2BF">&#x3C;&#x26;</span><span style="color: #E5C07B">Path</span><span style="color: #ABB2BF">>, </span><span style="color: #E06C75">files</span><span style="color: #ABB2BF">: &#x26;[</span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">]) -> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Result</span><span style="color: #ABB2BF">&#x3C;()> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">writer</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">Box</span><span style="color: #ABB2BF">&#x3C;</span><span style="color: #C678DD">dyn</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Write</span><span style="color: #ABB2BF">> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">match</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">archive_path</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Some</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">) => </span><span style="color: #E5C07B">Box</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">BufWriter</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">create</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">)?)),</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">None</span><span style="color: #ABB2BF"> => </span><span style="color: #E5C07B">Box</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">BufWriter</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">stdout</span><span style="color: #ABB2BF">())),</span></span>
<span class="line"><span style="color: #ABB2BF"> };</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">builder</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Builder</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">writer</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file_path</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">files</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Path</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file_path</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">meta</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">metadata</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">header</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Header</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new_gnu</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">header</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">set_path</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">header</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">set_size</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">meta</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">len</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">header</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">set_mode</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">meta</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">mode</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">header</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">set_cksum</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">open</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">builder</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">append</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">header</span><span style="color: #ABB2BF">, &#x26;</span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Ok</span><span style="color: #ABB2BF">(())</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>In this implementation, we first check if <code>archive_path</code> is <code>Some</code>. If it is, we create a new <code>File</code> instance at the specified path, wrap it in a <code>BufWriter</code>, and use a <code>Box&#x3C;dyn Write></code> to store it in the <code>writer</code> variable. If <code>archive_path</code> is <code>None</code>, we instead wrap <code>std::io::stdout()</code> in a <code>BufWriter</code> and store that in the <code>writer</code> variable.</p>
<p>We then create a new <code>Builder</code> instance using the <code>writer</code> variable. We loop through each file in <code>files</code>, create a new <code>Path</code> instance, get metadata about the file, create a new <code>Header</code> instance, and append the file to the archive using the <code>append()</code> method.</p>
<p>This updated implementation should allow the <code>tar</code> command to output the archive to either the console or a specified file.</p>
<p>Testing the tar command
To test the <code>tar</code> command, we can create a few files and directories to include in the archive, and then run the command to create the archive and verify its contents.</p>
<p>Here’s an example test:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::{create_dir, write};</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Read</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">path</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">PathBuf</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">tempfile</span><span style="color: #ABB2BF">::tempdir;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">assert_cmd</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Command</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">#[test]</span></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">test_tar</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">dir</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">tempdir</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">expect</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"failed to create temp dir"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Create some files and directories to include in the archive</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file1_path</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">dir</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">join</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"file1.txt"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file2_path</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">dir</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">join</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"file2.txt"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">dir1_path</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">dir</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">join</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"dir1"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">dir2_path</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">dir</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">join</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"dir2"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">write</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">file1_path</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"hello"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">expect</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"failed to write file1"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">write</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">file2_path</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"world"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">expect</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"failed to write file2"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">create_dir</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">dir1_path</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">expect</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"failed to create dir1"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">create_dir</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">dir2_path</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">expect</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"failed to create dir2"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Create the tar archive</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">output_file</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">dir</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">join</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"output.tar"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">cmd</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Command</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">cargo_bin</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"tar"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">assert</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">cmd</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"cf"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">output_file</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file1_path</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">to_str</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">())</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file2_path</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">to_str</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">())</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">dir1_path</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">to_str</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">())</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">dir2_path</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">to_str</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">())</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">assert</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Ensure the command succeeded</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">assert</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">success</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Verify the contents of the tar archive</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">archive_file</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">open</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">output_file</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">expect</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"failed to open archive file"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">archive</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">tar</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Archive</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">archive_file</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entries</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">archive</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">entries</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">expect</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"failed to get archive entries"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Check the first file in the archive</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entries</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">next</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">expect</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"no entries in archive"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">assert_eq!</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">(), </span><span style="color: #E5C07B">PathBuf</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">from</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"file1.txt"</span><span style="color: #ABB2BF">));</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">content</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">read_to_string</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">content</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">expect</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"failed to read file1.txt"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">assert_eq!</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">content</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"hello"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Check the second file in the archive</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entries</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">next</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">expect</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"not enough entries in archive"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">assert_eq!</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">(), </span><span style="color: #E5C07B">PathBuf</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">from</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"file2.txt"</span><span style="color: #ABB2BF">));</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">content</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">read_to_string</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">content</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">expect</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"failed to read file2.txt"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">assert_eq!</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">content</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"world"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Check the first directory in the archive</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entries</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">next</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">expect</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"not enough entries in archive"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">assert_eq!</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">(), </span><span style="color: #E5C07B">PathBuf</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">from</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"dir1/"</span><span style="color: #ABB2BF">));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Check the second directory in the archive</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entries</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">next</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">expect</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"not enough entries in archive"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">assert_eq!</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">(), </span><span style="color: #E5C07B">PathBuf</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">from</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"dir2/"</span><span style="color: #ABB2BF">));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Ensure there are no more entries in the archive</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">assert!</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">entries</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">next</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">is_none</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>This test creates a temporary directory using the <code>tempdir()</code> function from the <code>tempfile</code> crate. It then creates a few files and directories in the temporary directory, and runs the <code>tar</code> command to create an archive containing those files and directories. Finally, it reads the contents of the archive and verifies that the expected files and directories are present, and that their contents match the expected values.</p>
<h1 id="chapter-12-building-a-chmod-command">Chapter 12: Building a Chmod Command</h1>
<p>Overview of the chmod command and its functionality
The <code>chmod</code> command is a common Unix/Linux command used to change the permissions of a file or directory. The name “chmod” is short for “change mode”.</p>
<p>The <code>chmod</code> command allows a user to change the read, write, and execute permissions of a file or directory. These permissions are usually represented by a three-digit number, where each digit represents the permissions for the file owner, group, and other users, respectively. The permissions are represented as follows:</p>
<ul>
<li>4 = read permission</li>
<li>2 = write permission</li>
<li>1 = execute permission</li>
<li>0 = no permission</li>
</ul>
<p>For example, a permission of 755 means that the file owner has read, write, and execute permissions, while group and other users only have read and execute permissions.</p>
<p>The <code>chmod</code> command can be used in two different ways: with a numeric mode or with a symbolic mode. The numeric mode is used to specify the new permissions directly, while the symbolic mode is used to specify the permissions using a more descriptive syntax.</p>
<p>Here’s an example of how to use the <code>chmod</code> command with the numeric mode to set the permissions of a file to 644:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #E06C75">shell</span><span style="color: #ABB2BF">`$ </span><span style="color: #E06C75">chmod</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">644</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">myfile</span><span style="color: #ABB2BF">.txt</span></span></code></pre>
<p>And here’s an example of how to use the <code>chmod</code> command with the symbolic mode to add write permissions for the file owner:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #E06C75">shell</span><span style="color: #ABB2BF">`$ </span><span style="color: #E06C75">chmod</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">u</span><span style="color: #ABB2BF">+</span><span style="color: #E06C75">w</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">myfile</span><span style="color: #ABB2BF">.txt</span></span></code></pre>
<p>In this example, the <code>u</code> refers to the file owner, and the <code>+w</code> adds write permissions for the file owner.</p>
<p>The <code>chmod</code> command can also be used recursively with the <code>-R</code> option to change the permissions of a directory and all of its contents.</p>
<p>In summary, the <code>chmod</code> command is a powerful tool for managing file and directory permissions in Unix/Linux systems. It allows users to change the permissions of files and directories using either a numeric or symbolic mode, and can be used recursively to apply permissions changes to entire directory trees.</p>
<p>Designing the Rust implementation of the chmod command
To implement the <code>chmod</code> command in Rust, we will need to:</p>
<ol>
<li>Parse the command line arguments to determine the new permissions and the file or directory to modify.</li>
<li>Use the <code>std::fs::metadata</code> function to retrieve the current permissions of the file or directory.</li>
<li>Use bitwise operations to modify the permissions based on the user’s input.</li>
<li>Use the <code>std::fs::set_permissions</code> function to set the new permissions on the file or directory.</li>
</ol>
<p>Here’s an outline of what the Rust code might look like:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::{metadata, set_permissions, </span><span style="color: #E5C07B">Permissions</span><span style="color: #ABB2BF">};</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">os</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">unix</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">PermissionsExt</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">path</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">PathBuf</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Parse command line arguments</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">args</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">Vec</span><span style="color: #ABB2BF">&#x3C;</span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">env</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">args</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">collect</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Extract the new permissions and file/directory path from the arguments</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">new_perms</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">) </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">parse_args</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">args</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Get the current permissions of the file/directory</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">metadata</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">metadata</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">expect</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Failed to read metadata"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">perms</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">metadata</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">permissions</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Modify the permissions based on the user's input</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">perms</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">set_mode</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">new_perms</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Set the new permissions on the file/directory</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">set_permissions</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">perms</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">expect</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Failed to set permissions"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">parse_args</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">args</span><span style="color: #ABB2BF">: &#x26;[</span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">]) -> (</span><span style="color: #E5C07B">u32</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">PathBuf</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // TODO: implement argument parsing</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">unimplemented!</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>In this code, we first parse the command line arguments using a <code>parse_args</code> function (which we have not yet implemented). The <code>parse_args</code> function will extract the new permissions and file/directory path from the command line arguments.</p>
<p>We then use the <code>metadata</code> function to get the current permissions of the file or directory. We modify the permissions using bitwise operations and the <code>set_mode</code> method, and finally use the <code>set_permissions</code> function to set the new permissions on the file or directory.</p>
<p>Note that we also use the <code>PermissionsExt</code> trait from <code>std::os::unix::fs</code> to access the Unix-specific methods for manipulating file permissions.</p>
<p>Reading and processing the input file or directory and permission settings
To implement the chmod command in Rust, we first need to read and process the input file or directory and the permission settings provided by the user.</p>
<p>To read the input file or directory, we can make use of the <code>std::fs</code> module in Rust. We will use the <code>metadata()</code> function to retrieve the metadata of the file or directory, and then the <code>permissions()</code> function to get the current permissions of the file or directory.</p>
<p>To process the permission settings provided by the user, we can make use of the <code>std::os::unix::fs::PermissionsExt</code> trait, which provides methods for manipulating file permissions. We can use the <code>from_mode()</code> function to create a <code>Permissions</code> object from the integer value of the permission mode, which can be obtained by parsing the input permission string using the <code>u32::from_str_radix()</code> function.</p>
<p>Once we have the current permissions of the file or directory and the desired permission settings, we can use the <code>set_permissions()</code> function to set the new permissions.</p>
<p>In addition to setting the permissions of a single file or directory, we may also need to set the permissions recursively for all files and directories within a directory. We can do this by traversing the directory tree using the <code>std::fs::read_dir()</code> function to get the contents of each directory, and then recursively calling the <code>chmod()</code> function on each subdirectory.</p>
<p>Overall, the implementation of the <code>chmod</code> command in Rust will involve reading and processing the input file or directory and permission settings, and then setting the new permissions using the <code>set_permissions()</code> function. If necessary, the command may also need to traverse the directory tree recursively to set the permissions for all files and directories within a directory.</p>
<p>Implementing the chmod functionality
To implement the <code>chmod</code> command in Rust, we can create a function that takes two arguments: the path to the file or directory to modify, and the permission string in octal format. Here is an example implementation:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::fs;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">os</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">unix</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">PermissionsExt</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">path</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Path</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">error</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Error</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">chmod</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">: &#x26;</span><span style="color: #E5C07B">Path</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">mode_str</span><span style="color: #ABB2BF">: &#x26;</span><span style="color: #E5C07B">str</span><span style="color: #ABB2BF">) -> </span><span style="color: #E5C07B">Result</span><span style="color: #ABB2BF">&#x3C;(), </span><span style="color: #E5C07B">Box</span><span style="color: #ABB2BF">&#x3C;</span><span style="color: #C678DD">dyn</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Error</span><span style="color: #ABB2BF">>> {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Parse the permission string to get the new mode</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">mode</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">u32</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">from_str_radix</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">mode_str</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">8</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Get the current metadata and permissions of the file or directory</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">metadata</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">metadata</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">permissions</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">metadata</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">permissions</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Set the new permissions</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">permissions</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">set_mode</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">mode</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">set_permissions</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">permissions</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // If the path is a directory, recursively set the permissions for its contents</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">metadata</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_dir</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">read_dir</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">)? {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">?;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">child_path</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">entry</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">path</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">chmod</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">child_path</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">mode_str</span><span style="color: #ABB2BF">)?;</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Ok</span><span style="color: #ABB2BF">(())</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>In this implementation, we first parse the permission string to obtain the new mode. We then use the <code>fs::metadata()</code> function to get the current metadata of the file or directory, and the <code>permissions()</code> function to get its current permissions. We set the new mode using the <code>set_mode()</code> method of the <code>Permissions</code> object, and then use the <code>fs::set_permissions()</code> function to apply the new permissions to the file or directory.</p>
<p>If the path is a directory, we use the <code>fs::read_dir()</code> function to get a list of its contents, and then recursively call the <code>chmod()</code> function on each child path.</p>
<p>This implementation returns a <code>Result</code> object with an <code>Ok</code> value if the operation is successful, or an <code>Err</code> value containing an error message if an error occurs.</p>
<p>Outputting the results to the console
Since <code>chmod</code> only modifies the permissions of files or directories, there is no output to the console other than an error message if the operation fails. Therefore, we can print a message indicating that the operation was successful. Here’s an example:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Permissions updated successfully."</span><span style="color: #ABB2BF">);</span></span></code></pre>
<p>This message can be printed at the end of the <code>chmod</code> function, after the permissions have been updated. If an error occurs, we can print an error message instead.</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #61AFEF">eprintln!</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Error: {}"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">error</span><span style="color: #ABB2BF">);</span></span></code></pre>
<p>Here, we use the <code>eprintln!</code> macro to print an error message to the standard error stream. This way, any errors that occur during the <code>chmod</code> operation will be printed to the console.</p>
<p>Testing the chmod command
To test the <code>chmod</code> command, we can manually change the permissions of a file or directory using the <code>chmod</code> command in the terminal, and then use our Rust implementation to verify that the permissions have been updated correctly.</p>
<p>We can also create a test directory and file with specific permissions using Rust, and then use our <code>chmod</code> command to modify the permissions and verify that they have been updated correctly.</p>
<p>Here’s an example test case:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">os</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">unix</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">PermissionsExt</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">#[test]</span></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">test_chmod</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Create a test directory and file with specific permissions</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">test_dir</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">env</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">temp_dir</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">join</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"test_chmod"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">test_file</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">test_dir</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">join</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"test_file.txt"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">create_dir_all</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">test_dir</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">create</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">test_file</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">write_all</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">b"test"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">permissions</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Permissions</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">from_mode</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0o644</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">set_permissions</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">test_file</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">permissions</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Modify the permissions using our Rust implementation of chmod</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">args</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">vec!</span><span style="color: #ABB2BF">[</span><span style="color: #98C379">"chmod"</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"u+w"</span><span style="color: #ABB2BF">, &#x26;</span><span style="color: #E06C75">test_file</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">to_string_lossy</span><span style="color: #ABB2BF">()];</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">App</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"chmod"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">version</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"1.0"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">author</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Your Name"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">about</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Change file or directory permissions."</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"permissions"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">required</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">multiple</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"The new permissions for the file or directory."</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"file"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">required</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"The file or directory to modify."</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">get_matches_from</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">args</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">chmod</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Verify that the permissions have been updated correctly</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">updated_permissions</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">metadata</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">test_file</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">permissions</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">assert_eq!</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">updated_permissions</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">mode</span><span style="color: #ABB2BF">() &#x26; </span><span style="color: #D19A66">0o777</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0o646</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"> // Clean up the test directory and file</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">remove_file</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">test_file</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">remove_dir</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #E06C75">test_dir</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>This test case creates a test directory and file with permissions <code>644</code>, modifies the permissions using our Rust implementation of <code>chmod</code>, and then verifies that the permissions have been updated correctly to <code>646</code>. Finally, it cleans up the test directory and file.</p>
<h1 id="chapter-13-building-a-wget-command">Chapter 13: Building a Wget Command</h1>
<p>Overview of the wget command and its functionality
The <code>wget</code> command is a utility that retrieves files from the web using HTTP, HTTPS, and FTP protocols. It is used to download files from a specified URL and save them to the local file system. <code>wget</code> is a powerful tool with many features, such as resuming downloads, recursive downloads, and downloading files based on specified criteria. The <code>wget</code> command is commonly used in scripts to automate downloads of files and web pages.</p>
<p>Designing the Rust implementation of the wget command
The Rust implementation of the <code>wget</code> command will involve retrieving files from the web using the HTTP, HTTPS, and FTP protocols. The implementation will support the following functionalities:</p>
<ul>
<li>Downloading a single file from a given URL</li>
<li>Downloading multiple files from a given URL using a specified pattern or list of URLs</li>
<li>Resuming a download that was previously interrupted</li>
<li>Specifying the output file name and location</li>
<li>Displaying progress information during the download</li>
</ul>
<p>To achieve these functionalities, we will use Rust’s built-in libraries such as <code>reqwest</code> and <code>indicatif</code>. <code>reqwest</code> is a popular Rust HTTP client library that makes it easy to send HTTP requests and receive responses. <code>indicatif</code> is a Rust library that provides a set of progress bars and spinners to indicate the progress of long-running tasks.</p>
<p>The Rust implementation of the <code>wget</code> command will involve the following steps:</p>
<ol>
<li>Parse the command-line arguments to extract the URL and any other options.</li>
<li>Send an HTTP GET request to the URL using <code>reqwest</code>.</li>
<li>If the server returns a successful response, create a file to store the downloaded content and write the response body to the file.</li>
<li>If the download is interrupted, allow the user to resume the download by sending a range request to the server with the <code>Range</code> header.</li>
<li>Display the progress of the download using the <code>ProgressBar</code> provided by <code>indicatif</code>.</li>
</ol>
<p>With these steps, we can create a Rust implementation of the <code>wget</code> command that can download files from the web with ease.</p>
<p>Reading and processing the input URL and download options
To implement the <code>wget</code> command in Rust, we first need to read and process the input URL and download options provided by the user.</p>
<p>We can use the <code>clap</code> crate to define and parse command-line arguments. Here’s an example of how we can define the <code>wget</code> command-line arguments:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">App</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"wget"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">version</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"1.0"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"url"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">takes_value</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">required</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">index</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"URL to download"</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"output"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">short</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"O"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">long</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"output"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">takes_value</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Output file path"</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"timeout"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">short</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"t"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">long</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"timeout"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">takes_value</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Timeout in seconds"</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"tries"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">short</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"T"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">long</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"tries"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">takes_value</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Number of tries"</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">get_matches</span><span style="color: #ABB2BF">();</span></span></code></pre>
<p>This code defines the <code>url</code> argument, which is a required argument and represents the URL to download. It also defines the <code>output</code>, <code>timeout</code>, and <code>tries</code> arguments, which are optional.</p>
<p>Once we have parsed the command-line arguments, we can use the <code>reqwest</code> crate to download the file from the given URL. Here’s an example of how we can use <code>reqwest</code> to download a file:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">client</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">reqwest</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Client</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">builder</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">timeout</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Duration</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">from_secs</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">timeout</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">build</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">response</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">client</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">url</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">send</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">content</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Vec</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #E06C75">response</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">copy_to</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">content</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span></code></pre>
<p>This code creates a <code>reqwest::Client</code> with the given timeout, sends a GET request to the URL, and reads the response into a buffer. We can then write the contents of this buffer to the output file, or to the console if no output file is specified.</p>
<p>Implementing the wget functionality
To implement the wget functionality in Rust, we can use the <code>reqwest</code> crate to make HTTP requests and download files.</p>
<p>Here’s an example implementation of the <code>wget</code> command in Rust:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">io</span><span style="color: #ABB2BF">::copy;</span></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">path</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Path</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">clap</span><span style="color: #ABB2BF">::{</span><span style="color: #E5C07B">App</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">use</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">reqwest</span><span style="color: #ABB2BF">::</span><span style="color: #E5C07B">Client</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">fn</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">App</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"wget"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"url"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">required</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">index</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"URL to download"</span><span style="color: #ABB2BF">),</span></span>
<span class="line"><span style="color: #ABB2BF"> )</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"output"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">short</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"O"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">takes_value</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Output file path"</span><span style="color: #ABB2BF">),</span></span>
<span class="line"><span style="color: #ABB2BF"> )</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">arg</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Arg</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">with_name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"quiet"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">short</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"q"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">help</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Quiet mode: do not print download progress"</span><span style="color: #ABB2BF">),</span></span>
<span class="line"><span style="color: #ABB2BF"> )</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">get_matches</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">url</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">value_of</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"url"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">output_path</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">value_of</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"output"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">map</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Path</span><span style="color: #ABB2BF">::</span><span style="color: #E06C75">new</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">quiet</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">matches</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">is_present</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"quiet"</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">client</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Client</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">response</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">client</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">url</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">send</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">match</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">output_path</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Some</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">) => </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">create</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">(),</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">None</span><span style="color: #ABB2BF"> => </span><span style="color: #E5C07B">File</span><span style="color: #ABB2BF">::</span><span style="color: #61AFEF">create</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"downloaded_file"</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">(),</span></span>
<span class="line"><span style="color: #ABB2BF"> };</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">quiet</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">copy</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">response</span><span style="color: #ABB2BF">, &#x26;</span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF"> } </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">response</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">content_length</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">unwrap_or</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">downloaded_size</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">copy</span><span style="color: #ABB2BF">(&#x26;</span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">response</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">by_ref</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">take</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF">), &#x26;</span><span style="color: #C678DD">mut</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unwrap</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">println!</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #98C379">"Downloaded {} bytes to {}"</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">total_size</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">output_path</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">map</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">|</span><span style="color: #E06C75">path</span><span style="color: #56B6C2">|</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">path</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">display</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">to_string</span><span style="color: #ABB2BF">())</span></span>
<span class="line"><span style="color: #ABB2BF"> .</span><span style="color: #61AFEF">unwrap_or</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"downloaded_file"</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">to_string</span><span style="color: #ABB2BF">())</span></span>
<span class="line"><span style="color: #ABB2BF"> );</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre>
<p>In this implementation, we use the <code>clap</code> crate to define command line arguments, including the URL to download, the output file path, and whether to run in quiet mode. We then use <code>reqwest</code> to make an HTTP request to download the file, and write the downloaded content to a file. If quiet mode is not enabled, we also print the progress of the download to the console.</p>
<p>To use this implementation, we can compile the Rust code into an executable binary and run it with the URL to download as a command line argument, like so:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #E06C75">shell</span><span style="color: #ABB2BF">`$ </span><span style="color: #E06C75">cargo</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">build</span><span style="color: #ABB2BF"> --</span><span style="color: #E06C75">release</span></span>
<span class="line"><span style="color: #ABB2BF">$ ./</span><span style="color: #E06C75">target</span><span style="color: #ABB2BF">/</span><span style="color: #E06C75">release</span><span style="color: #ABB2BF">/</span><span style="color: #E06C75">wget</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">https</span><span style="color: #ABB2BF">:</span><span style="color: #7F848E; font-style: italic">//example.com/file.txt</span></span></code></pre>
<p>This will download the file at the given URL and save it to a file named <code>downloaded_file</code> in the current directory. We can also specify an output file path with the <code>-O</code> option:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #E06C75">shell</span><span style="color: #ABB2BF">`$ ./</span><span style="color: #E06C75">target</span><span style="color: #ABB2BF">/</span><span style="color: #E06C75">release</span><span style="color: #ABB2BF">/</span><span style="color: #E06C75">wget</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">https</span><span style="color: #ABB2BF">:</span><span style="color: #7F848E; font-style: italic">//example.com/file.txt -O /path/to/output/file.txt</span></span></code></pre>
<p>This will download the file at the given URL and save it to the specified output file path.</p>
<p>Outputting the results to the console or downloaded file
The <code>wget</code> command typically downloads a file from a specified URL and saves it to the local file system. Therefore, the output is usually a downloaded file. However, the progress of the download may also be output to the console.</p>
<p>Testing the wget command
To test the <code>wget</code> command, you can provide a URL for a file that you know is available for download, and then check if the file was downloaded to your local file system. You can also verify that the file is not corrupted and that the downloaded file matches the original file.</p>
<p>For example, you can download a file from a public URL, such as <code>http://speedtest.tele2.net/1GB.zip</code>, and save it to the current working directory using the <code>wget</code> command as follows:</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #E06C75">wget</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">http</span><span style="color: #ABB2BF">:</span><span style="color: #7F848E; font-style: italic">//speedtest.tele2.net/1GB.zip</span></span></code></pre>
<p>Once the download is complete, you can verify that the file was downloaded by checking that the file exists in the current working directory. You can also verify that the file is not corrupted and that the downloaded file matches the original file by computing a checksum for both files and comparing them.</p>
<p>For example, on Linux, you can compute the MD5 checksum of the downloaded file using the <code>md5sum</code> command and compare it to the MD5 checksum of the original file, which is provided on the download page. If the two checksums match, the file is likely to be identical.</p>
<pre is:raw="" class="astro-code one-dark-pro" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color: #E06C75">md5sum</span><span style="color: #ABB2BF"> 1GB.zip</span></span></code></pre>
<p>This will output the MD5 checksum of the downloaded file. You can compare it to the MD5 checksum provided on the download page to verify that the file was downloaded correctly.</p>
<h1 id="chapter-14-conclusion">Chapter 14: Conclusion</h1>
<p>Summary of the book
In this technical book, we covered several essential command-line tools and their Rust implementations. We started with an introduction to Rust and command-line applications, followed by an overview of each tool and its functionality. We then discussed the Rust implementation of each tool, starting with reading and processing the input, implementing the functionality, and outputting the results to the console or file. Finally, we tested each tool to ensure it works correctly.</p>
<p>The tools covered in this book include:</p>
<ul>
<li>Locate: a tool that searches for files and directories on the system.</li>
<li>Find: a tool that recursively searches for files and directories that match a specific search query.</li>
<li>Grep: a tool that searches for a specific pattern within a file.</li>
<li>Tar: a tool that creates archives of files and directories.</li>
<li>Chmod: a tool that changes the permissions of a file or directory.</li>
<li>Wget: a tool that downloads files from the internet.</li>
</ul>
<p>By the end of this book, readers will have a solid understanding of how to create command-line applications in Rust and will be able to apply this knowledge to other projects.</p>
<p>Further resources for building command line applications in Rust
There are a number of resources available for building command line applications in Rust. Some useful ones include:</p>
<ol>
<li>The Rust Programming Language Book: This book is a comprehensive guide to Rust and includes a section on building command line applications.</li>
<li>The clap crate: This is a popular crate for building command line interfaces in Rust. It provides a simple and powerful API for defining and parsing command line arguments.</li>
<li>The structopt crate: This is another popular crate for building command line interfaces in Rust. It provides a way to define command line arguments using Rust structs and attributes.</li>
<li>The console crate: This crate provides a set of utilities for building interactive command line interfaces in Rust.</li>
<li>The Rustyline crate: This crate provides a library for building line-based command line interfaces with advanced features like history, tab-completion, and syntax highlighting.</li>
<li>The Rust CLI Working Group: This is a community group focused on developing best practices and tools for building command line applications in Rust.</li>
</ol>
<p>These resources can be very helpful for building robust and user-friendly command line applications in Rust.</p>
            </article>
          </div>
          <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();;(()=>{var c;{let d={0:t=>t,1:t=>JSON.parse(t,o),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(JSON.parse(t,o)),5:t=>new Set(JSON.parse(t,o)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(JSON.parse(t)),9:t=>new Uint16Array(JSON.parse(t)),10:t=>new Uint32Array(JSON.parse(t))},o=(t,r)=>{if(t===""||!Array.isArray(r))return r;let[e,n]=r;return e in d?d[e](n):void 0};customElements.get("astro-island")||customElements.define("astro-island",(c=class extends HTMLElement{constructor(){super(...arguments);this.hydrate=()=>{var l;if(!this.hydrator||!this.isConnected||(l=this.parentElement)!=null&&l.closest("astro-island[ssr]"))return;let r=this.querySelectorAll("astro-slot"),e={},n=this.querySelectorAll("template[data-astro-template]");for(let s of n){let i=s.closest(this.tagName);!i||!i.isSameNode(this)||(e[s.getAttribute("data-astro-template")||"default"]=s.innerHTML,s.remove())}for(let s of r){let i=s.closest(this.tagName);!i||!i.isSameNode(this)||(e[s.getAttribute("name")||"default"]=s.innerHTML)}let a=this.hasAttribute("props")?JSON.parse(this.getAttribute("props"),o):{};this.hydrator(this)(this.Component,a,e,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),window.removeEventListener("astro:hydrate",this.hydrate),window.dispatchEvent(new CustomEvent("astro:hydrate"))}}connectedCallback(){!this.hasAttribute("await-children")||this.firstChild?this.childrenConnectedCallback():new MutationObserver((r,e)=>{e.disconnect(),setTimeout(()=>this.childrenConnectedCallback(),0)}).observe(this,{childList:!0})}async childrenConnectedCallback(){window.addEventListener("astro:hydrate",this.hydrate);let r=this.getAttribute("before-hydration-url");r&&await import(r),this.start()}start(){let r=JSON.parse(this.getAttribute("opts")),e=this.getAttribute("client");if(Astro[e]===void 0){window.addEventListener(`astro:${e}`,()=>this.start(),{once:!0});return}Astro[e](async()=>{let n=this.getAttribute("renderer-url"),[a,{default:l}]=await Promise.all([import(this.getAttribute("component-url")),n?import(n):()=>()=>{}]),s=this.getAttribute("component-export")||"default";if(!s.includes("."))this.Component=a[s];else{this.Component=a;for(let i of s.split("."))this.Component=this.Component[i]}return this.hydrator=l,this.hydrate},r,this)}attributeChangedCallback(){this.hydrate()}},c.observedAttributes=["props"],c))}})();</script><astro-island uid="ZbKvuO" prefix="r0" component-url="/_astro/Disqus.101366bd.js" component-export="default" renderer-url="/_astro/client.663bf61e.js" props="{}" ssr="" client="load" opts="{&quot;name&quot;:&quot;Disqus&quot;,&quot;value&quot;:true}" await-children=""><div class="row mt-16 justify-center "><div id="disqus_thread"></div></div></astro-island>
        </div>
      </div>
    </div>
  </section>

    </main>
    <footer class="footer bg-[#F1F1F1]">
  <div class="container">
    <div class="gx-5 row pb-10 pt-[52px]">
      <div class="col-12 mt-12 md:col-6 lg:col-3">
        <a href="/" class="navbar-brand block">
  <img alt="Pinwheel Astro" style="height:31px;width:147px" width="294" height="62" src="/_astro/logo_ZThIBR.png" loading="lazy" decoding="async">
</a>
        <p class="mt-6">
          Trying to make the world a better place.
        </p>
      </div>
      <div class="col-12 mt-12 md:col-6 lg:col-3">
        <h6>Socials</h6>

        <ul class="social-icons mt-4 lg:mt-6">
  <li class="inline-block">
        <a aria-label="facebook" href="https://facebook.com/" target="_blank" rel="noopener noreferrer nofollow">
          <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M480 257.35c0-123.7-100.3-224-224-224s-224 100.3-224 224c0 111.8 81.9 204.47 189 221.29V322.12h-56.89v-64.77H221V208c0-56.13 33.45-87.16 84.61-87.16 24.51 0 50.15 4.38 50.15 4.38v55.13H327.5c-27.81 0-36.51 17.26-36.51 35v42h62.12l-9.92 64.77H291v156.54c107.1-16.81 189-109.48 189-221.31z"></path></svg>
        </a>
      </li>
  <li class="inline-block">
        <a aria-label="twitter" href="https://twitter.com/" target="_blank" rel="noopener noreferrer nofollow">
          <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M496 109.5a201.8 201.8 0 01-56.55 15.3 97.51 97.51 0 0043.33-53.6 197.74 197.74 0 01-62.56 23.5A99.14 99.14 0 00348.31 64c-54.42 0-98.46 43.4-98.46 96.9a93.21 93.21 0 002.54 22.1 280.7 280.7 0 01-203-101.3A95.69 95.69 0 0036 130.4c0 33.6 17.53 63.3 44 80.7A97.5 97.5 0 0135.22 199v1.2c0 47 34 86.1 79 95a100.76 100.76 0 01-25.94 3.4 94.38 94.38 0 01-18.51-1.8c12.51 38.5 48.92 66.5 92.05 67.3A199.59 199.59 0 0139.5 405.6a203 203 0 01-23.5-1.4A278.68 278.68 0 00166.74 448c181.36 0 280.44-147.7 280.44-275.8 0-4.2-.11-8.4-.31-12.5A198.48 198.48 0 00496 109.5z"></path></svg>
        </a>
      </li>
  
  
  
  <li class="inline-block">
        <a aria-label="linkedin" href="https://linkedin.com/" target="_blank" rel="noopener noreferrer nofollow">
          <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M444.17 32H70.28C49.85 32 32 46.7 32 66.89v374.72C32 461.91 49.85 480 70.28 480h373.78c20.54 0 35.94-18.21 35.94-38.39V66.89C480.12 46.7 464.6 32 444.17 32zm-273.3 373.43h-64.18V205.88h64.18zM141 175.54h-.46c-20.54 0-33.84-15.29-33.84-34.43 0-19.49 13.65-34.42 34.65-34.42s33.85 14.82 34.31 34.42c-.01 19.14-13.31 34.43-34.66 34.43zm264.43 229.89h-64.18V296.32c0-26.14-9.34-44-32.56-44-17.74 0-28.24 12-32.91 23.69-1.75 4.2-2.22 9.92-2.22 15.76v113.66h-64.18V205.88h64.18v27.77c9.34-13.3 23.93-32.44 57.88-32.44 42.13 0 74 27.77 74 87.64z"></path></svg>
        </a>
      </li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="inline-block">
        <a aria-label="skype" href="https://skype.com/" target="_blank" rel="noopener noreferrer nofollow">
          <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M467.16 303.6a205.69 205.69 0 004.9-45.15c0-116.32-95.69-210.7-213.79-210.7a221.83 221.83 0 00-36.52 3A123.58 123.58 0 00155.93 32C87.55 32 32 86.72 32 154.15A119.56 119.56 0 0049 216a211.16 211.16 0 00-4.32 42.35c0 116.44 95.69 210.7 213.67 210.7a214 214 0 0039.09-3.5A125.45 125.45 0 00356.07 480C424.57 480 480 425.28 480 357.85a118 118 0 00-12.84-54.25zM368 359c-9.92 13.76-24.51 24.73-43.41 32.43S283.36 403 257.69 403c-30.69 0-56.36-5.37-76.55-15.87a101 101 0 01-35.24-30.8c-9.11-12.83-13.66-25.66-13.66-38 0-7.7 3-14.35 8.87-19.95 5.84-5.37 13.42-8.17 22.29-8.17 7.35 0 13.65 2.1 18.79 6.42 4.9 4.08 9.1 10.15 12.48 18.08A108.09 108.09 0 00207 336.15q6.32 8.22 17.86 13.65c7.82 3.62 18.2 5.48 31 5.48 17.62 0 32.09-3.73 42.94-11.08 10.74-7.12 15.88-15.75 15.88-26.25 0-8.28-2.69-14.82-8.29-19.95-5.83-5.37-13.42-9.57-22.87-12.37-9.69-3-22.87-6.18-39.21-9.56-22.17-4.67-41-10.27-56-16.57-15.28-6.42-27.65-15.4-36.76-26.48-9.22-11.32-13.77-25.55-13.77-42.24a67.86 67.86 0 0114.47-42.58c9.57-12.25 23.46-21.82 41.55-28.35 17.74-6.53 38.86-9.8 62.66-9.8 19.14 0 35.83 2.22 49.83 6.42s25.91 10.15 35.36 17.38 16.34 14.93 20.77 23 6.66 16.22 6.66 24c0 7.46-2.92 14.35-8.76 20.3a29.65 29.65 0 01-21.94 9.1c-7.93 0-14.12-1.87-18.43-5.6-4-3.5-8.17-8.87-12.72-16.69-5.37-9.91-11.79-17.85-19.14-23.45-7.24-5.36-19.14-8.16-35.71-8.16-15.29 0-27.77 3-37 9-8.87 5.72-13.19 12.37-13.19 20.18a18.26 18.26 0 004.32 12.25 38.13 38.13 0 0012.72 9.57 90.14 90.14 0 0017.15 6.53c6 1.64 15.87 4.09 29.53 7.12 17.38 3.62 33.25 7.82 47.26 12.13 14.24 4.55 26.49 10 36.52 16.45a72.93 72.93 0 0124.16 25.09c5.72 10 8.64 22.63 8.64 37.1A75.09 75.09 0 01368 359z"></path></svg>
        </a>
      </li>
  
  
  
  
  
</ul>
      </div>
      <div class="col-12 mt-12 md:col-6 lg:col-3">
        <h6>Quick Links</h6>
        <ul>
          <li class="mb-4">
                <a class="hover:text-primary hover:underline " href="/about">
                  About
                </a>
              </li><li class="mb-4">
                <a class="hover:text-primary hover:underline " href="/contact">
                  Contact
                </a>
              </li><li class="mb-4">
                <a class="hover:text-primary hover:underline " href="/elements">
                  Elements
                </a>
              </li><li class="mb-0">
                <a class="hover:text-primary hover:underline " href="/changelog">
                  Changelog
                </a>
              </li>
        </ul>
      </div>
      <div class="col-12 mt-12 md:col-6 lg:col-3">
        <h6>Location & Contact</h6>
        <ul>
          <li class="mb-2">Somewhere in Canada</li>
          <li class="mb-2">
            <a class="mb-2 hover:text-primary" href="mailto:colourfulmerchtik@gmail.com">colourfulmerchtik@gmail.com</a>
          </li>
          <li>
            <a class="hover:text-primary hover:underline" href="tel:+704-555-0127">+704-555-0127</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
  <div class="container max-w-[1440px]">
    <div class="footer-copyright mx-auto border-t border-border pb-10 pt-7 text-center">
      <p class="content text-text">Copyright © 2023</p>
    </div>
  </div>
</footer>
    
    <script src="https://mediafiles.botpress.cloud/0df54034-3318-451a-aed0-3923a4ee25a5/webchat/config.js" defer></script>
  </body>
</html>